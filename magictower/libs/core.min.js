function core(){this.material={animates:{},images:{},bgms:{},sounds:{},ground:null,items:{},enemys:{},icons:{},events:{}};this.timeout={getItemTipTimeout:null,turnHeroTimeout:null};this.interval={heroMoveInterval:null,tipAnimate:null,openDoorAnimate:null,animateInterval:null};this.animateFrame={background:null,globalAnimate:!1,twoTime:null,fourTime:null,boxTime:null,moveTime:null,speed:null,weather:{time:null,type:null,level:0,nodes:[],data:null}};this.musicStatus={audioContext:null,startDirectly:!1,
bgmStatus:!1,soundStatus:!0,playingBgm:null,isPlaying:!1};this.platform={isOnline:!0,isPC:!0,isAndroid:!1,isIOS:!1,isWeChat:!1,isQQ:!1,isChrome:!1,supportCopy:!1,fileInput:null,fileReader:null,successCallback:null,errorCallback:null};this.domStyle={styles:[],scale:1};this.initStatus={played:!1,hero:{},floorId:null,thisMap:null,maps:null,checkBlock:{},lockControl:!1,heroMoving:0,heroStop:!0,automaticRoute:{autoHeroMove:!1,autoStep:0,movedStep:0,destStep:0,destX:null,destY:null,autoStepRoutes:[],moveStepBeforeStop:[],
lastDirection:null,cursorX:null,cursorY:null,moveDirectly:!1},downTime:null,route:[],replay:{replaying:!1,pausing:!1,animate:!1,toReplay:[],totalList:[],speed:1},saveIndex:null,shops:{},event:{id:null,data:null,selection:null,ui:null},textAttribute:{position:"center",title:[255,215,0,1],background:[0,0,0,.85],text:[255,255,255,1],bold:!1},curtainColor:null,usingCenterFly:!1,openingDoor:null,twoAnimateObjs:[],fourAnimateObjs:[],boxAnimateObjs:[]};this.status={}}
core.prototype.init=function(a){for(var b in a)core[b]=a[b];core.flags=core.clone(core.data.flags);core.values=core.clone(core.data.values);core.firstData=core.data.getFirstData();core.flags.enableExperience||(core.flags.enableLevelUp=!1);core.flags.canOpenBattleAnimate||(core.flags.showBattleAnimateConfirm=!1,core.flags.battleAnimate=!1,core.setLocalStorage("battleAnimate",!1));core.firstData.shops.forEach(function(a){core.initStatus.shops[a.id]=a});core.dom.versionLabel.innerHTML=core.firstData.version;
core.dom.logoLabel.innerHTML=core.firstData.title;document.title=core.firstData.title;document.getElementById("startLogo").innerHTML=core.firstData.title;core.material.items=core.items.getItems();core.initStatus.maps=core.maps.initMaps(core.floorIds);core.material.enemys=core.clone(core.enemys.getEnemys());core.material.icons=core.icons.getIcons();core.material.events=core.events.getEvents();core.platform.isOnline=0==location.protocol.indexOf("http");if(core.platform.isOnline){window.AudioContext=
window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;try{core.musicStatus.audioContext=new window.AudioContext}catch(c){console.log("\u8be5\u6d4f\u89c8\u5668\u4e0d\u652f\u6301AudioContext"),core.musicStatus.audioContext=null}}"Android;iPhone;SymbianOS;Windows Phone;iPad;iPod".split(";").forEach(function(a){if(0<=navigator.userAgent.indexOf(a)){if("iPhone"==a||"iPad"==a||"iPod"==a)core.platform.isIOS=!0;"Android"==a&&(core.platform.isAndroid=!0);core.platform.isPC=
!1}});try{core.platform.supportCopy=document.queryCommandSupported("copy")}catch(c){core.platform.supportCopy=!1}a=/Chrome\/(\d+)\./i.exec(navigator.userAgent);core.isset(a)&&50<=parseInt(a[1])&&(core.platform.isChrome=!0);core.platform.isSafari=/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent);core.platform.isQQ=/QQ/i.test(navigator.userAgent);core.platform.isWeChat=/MicroMessenger/i.test(navigator.userAgent);window.FileReader&&(core.platform.fileReader=new FileReader,core.platform.fileReader.onload=
function(){var a=core.platform.fileReader.result,b=null;try{if(b=JSON.parse(a),core.isset(b)){core.isset(core.platform.successCallback)&&core.platform.successCallback(b);return}}catch(e){}alert("\u4e0d\u662f\u6709\u6548\u7684JSON\u6587\u4ef6\uff01");core.isset(core.platform.errorCallback)&&core.platform.errorCallback()},core.platform.fileReader.onerror=function(){core.isset(core.platform.errorCallback)&&core.platform.errorCallback()});core.platform.isPC?core.musicStatus.startDirectly=!0:(a=navigator.connection,
core.isset(a)&&"wifi"==a.type&&(core.musicStatus.startDirectly=!0));core.musicStatus.bgmStatus=core.getLocalStorage("bgmStatus",!0);core.musicStatus.startDirectly||(core.musicStatus.bgmStatus=!1);core.setLocalStorage("bgmStatus",core.musicStatus.bgmStatus);core.musicStatus.soundStatus=core.getLocalStorage("soundStatus",!0);core.setLocalStorage("soundStatus",core.musicStatus.soundStatus);core.flags.battleAnimate=core.getLocalStorage("battleAnimate",core.flags.battleAnimate);core.flags.displayEnemyDamage=
core.getLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.flags.displayExtraDamage=core.getLocalStorage("extraDamage",core.flags.displayExtraDamage);core.material.ground=new Image;core.material.ground.src="images/ground.png";core.loader(function(){core.material.icons.hero.height=core.material.images.hero.height/4;core.setRequestAnimationFrame();core.showStartAnimate()})};
core.prototype.setRequestAnimationFrame=function(){(function(){for(var a=0,b=["webkit","moz"],e=0;e<b.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[b[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[e]+"CancelAnimationFrame"]||window[b[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16.7-(d-a));c=window.setTimeout(function(){b(d+e)},e);a=d+e;return c});
window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})();core.animateFrame.speed=core.values.animateSpeed;core.animateFrame.background=core.canvas.ui.createPattern(core.material.ground,"repeat");var a={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}},b=function(c){core.animateFrame.twoTime=core.animateFrame.twoTime||c;core.animateFrame.fourTime=core.animateFrame.fourTime||c;core.animateFrame.boxTime=core.animateFrame.boxTime||c;core.animateFrame.moveTime=
core.animateFrame.moveTime||c;core.animateFrame.weather.time=core.animateFrame.weather.time||c;if(core.animateFrame.globalAnimate&&core.isPlaying()){if(c-core.animateFrame.twoTime>core.animateFrame.speed&&core.isset(core.status.twoAnimateObjs)){for(var d=0;d<core.status.twoAnimateObjs.length;d++){var e=core.status.twoAnimateObjs[d];e.status=(e.status+1)%2;core.canvas.event.clearRect(e.x,e.y,32,32);core.canvas.event.drawImage(e.image,32*e.status,32*e.loc,32,32,e.x,e.y,32,32)}core.animateFrame.twoTime=
c}if(c-core.animateFrame.fourTime>core.animateFrame.speed/2&&core.isset(core.status.fourAnimateObjs)){for(d=0;d<core.status.fourAnimateObjs.length;d++)e=core.status.fourAnimateObjs[d],e.status=(e.status+1)%4,core.canvas.event.clearRect(e.x,e.y,32,32),core.canvas.event.drawImage(e.image,32*e.status,32*e.loc,32,32,e.x,e.y,32,32);core.animateFrame.fourTime=c}}c-core.animateFrame.boxTime>core.animateFrame.speed&&core.isset(core.status.boxAnimateObjs)&&0<core.status.boxAnimateObjs.length&&(core.drawBoxAnimate(),
core.animateFrame.boxTime=c);if(16<c-core.animateFrame.moveTime&&core.isset(core.status.heroMoving)&&0<core.status.heroMoving){d=core.getHeroLoc("x");e=core.getHeroLoc("y");var f=core.getHeroLoc("direction");4>=core.status.heroMoving?core.drawHero(f,d,e,"leftFoot",4*core.status.heroMoving*a[f].x,4*core.status.heroMoving*a[f].y):8>=core.status.heroMoving&&core.drawHero(f,d,e,"rightFoot",4*core.status.heroMoving*a[f].x,4*core.status.heroMoving*a[f].y);core.animateFrame.moveTime=c}if(core.isPlaying()&&
30<c-core.animateFrame.weather.time){if("rain"==core.animateFrame.weather.type&&0<core.animateFrame.weather.level)core.clearMap("weather",0,0,416,416),core.canvas.weather.strokeStyle="rgba(174,194,224,0.8)",core.canvas.weather.lineWidth=1,core.canvas.weather.lineCap="round",core.animateFrame.weather.nodes.forEach(function(a){core.canvas.weather.beginPath();core.canvas.weather.moveTo(a.x,a.y);core.canvas.weather.lineTo(a.x+a.l*a.xs,a.y+a.l*a.ys);core.canvas.weather.stroke();a.x+=a.xs;a.y+=a.ys;if(416<
a.x||416<a.y)a.x=416*Math.random(),a.y=-10}),core.canvas.weather.fill();else if("snow"==core.animateFrame.weather.type&&0<core.animateFrame.weather.level){core.clearMap("weather",0,0,416,416);core.canvas.weather.fillStyle="rgba(255, 255, 255, 0.8)";core.canvas.weather.beginPath();core.isset(core.animateFrame.weather.data)||(core.animateFrame.weather.data=0);core.animateFrame.weather.data+=.01;var g=core.animateFrame.weather.data;core.animateFrame.weather.nodes.forEach(function(a){core.canvas.weather.moveTo(a.x,
a.y);core.canvas.weather.arc(a.x,a.y,a.r,0,2*Math.PI,!0);a.x+=2*Math.sin(g);a.y+=Math.cos(g+a.d)+1+a.r/2;if(421<a.x||-5>a.x||416<a.y)Math.random()>1/3?(a.x=416*Math.random(),a.y=-10):(a.x=0<Math.sin(g)?-5:421,a.y=416*Math.random())});core.canvas.weather.fill()}core.animateFrame.weather.time=c}window.requestAnimationFrame(b)};window.requestAnimationFrame(b)};
core.prototype.showStartAnimate=function(a){core.dom.startPanel.style.opacity=1;core.dom.startPanel.style.display="block";core.dom.startTop.style.opacity=1;core.dom.startTop.style.display="block";core.dom.startButtonGroup.style.display="none";core.dom.startButtons.style.display="block";core.dom.levelChooseButtons.style.display="none";core.dom.curtain.style.background="#000000";core.dom.curtain.style.opacity=0;core.status.played=!1;core.clearStatus();core.clearMap("all");var b=1,c=window.setInterval(function(){b-=
.03;0>b&&(clearInterval(c),core.dom.startTop.style.display="none",core.dom.startButtonGroup.style.display="block",core.isset(a)&&a());core.dom.startTop.style.opacity=b},20)};core.prototype.hideStartAnimate=function(a){var b=1,c=window.setInterval(function(){b-=.03;0>b&&(clearInterval(c),core.dom.startPanel.style.display="none",core.isset(a)&&a());core.dom.startPanel.style.opacity=b},20)};core.prototype.setStartProgressVal=function(a){core.dom.startTopProgress.style.width=a+"%"};
core.prototype.setStartLoadTipText=function(a){core.dom.startTopLoadTips.innerHTML=a};
core.prototype.loader=function(a){var b=0,c=0;c=core.images.length;for(var d in core.sounds);for(d=0;d<core.images.length;d++)core.loadImage(core.images[d],function(d,f){core.setStartLoadTipText("\u6b63\u5728\u52a0\u8f7d\u56fe\u7247 "+d+"...");core.material.images[d]=f;b++;core.setStartLoadTipText(d+" \u52a0\u8f7d\u5b8c\u6bd5...");core.setStartProgressVal(100/c*b);if(b==c)if(core.material.images.pngs={},0==core.pngs.length)core.loadAutotile(a);else for(d=0;d<core.pngs.length;d++)core.loadImage(core.pngs[d],
function(b,c){core.material.images.pngs[b]=c;Object.keys(core.material.images.pngs).length==core.pngs.length&&core.loadAutotile(a)})})};core.prototype.loadAutotile=function(a){core.material.images.autotile={};var b=Object.keys(core.material.icons.autotile);if(0==b.length)core.loadAnimates(a);else for(var c=0;c<b.length;c++)core.loadImage(b[c],function(c,e){core.material.images.autotile[c]=e;Object.keys(core.material.images.autotile).length==b.length&&core.loadAnimates(a)})};
core.prototype.loadImage=function(a,b){try{core.setStartLoadTipText("\u52a0\u8f7d\u56fe\u7247 "+a+" \u4e2d...");var c=a;0>c.indexOf(".png")&&(c+=".png");var d=new Image;d.src="images/"+c+"?v="+main.version;d.complete?b(a,d):d.onload=function(){b(a,d)}}catch(e){alert(e)}};
core.prototype.loadAnimates=function(a){core.animates.forEach(function(a){var b=new XMLHttpRequest;b.open("GET","animates/"+a+".animate",!0);b.overrideMimeType("text/plain; charset=x-user-defined");b.onload=function(b){b=this.responseText;try{b=JSON.parse(b);var c={};c.ratio=b.ratio;c.images=[];c.images_rev=[];b.bitmaps.forEach(function(a){if(core.isset(a)&&""!=a)try{var b=new Image;b.src=a;c.images.push(b)}catch(h){c.images.push(null)}else c.images.push(null)});c.frame=b.frame_max;c.frames=[];b.frames.forEach(function(a){var b=
[];a.forEach(function(a){b.push({index:a[0],x:a[1],y:a[2],zoom:a[3],opacity:a[4],mirror:a[5]||0,angle:a[6]||0})});c.frames.push(b)});core.material.animates[a]=c}catch(f){core.material.animates[a]=null}};b.ontimeout=function(b){core.material.animates[a]=null};b.onerror=function(b){core.material.animates[a]=null};b.send()});core.loadMusic(a)};
core.prototype.loadMusic=function(a){core.bgms.forEach(function(a){if(/^.*\.mid$/i.test(a))if(null!=core.musicStatus.audioContext){core.material.bgms[a]="loading";var b=new XMLHttpRequest;b.open("GET","sounds/"+a,!0);b.overrideMimeType("text/plain; charset=x-user-defined");b.onload=function(b){try{b=[];for(var c=this.responseText.length,d=0;d<c;d++)b[d]=String.fromCharCode(this.responseText.charCodeAt(d)&255);var g="starting"==core.material.bgms[a];core.material.bgms[a]=AudioPlayer(core.musicStatus.audioContext,
Replayer(MidiFile(b.join("")),Synth(44100)),!0);g&&core.playBgm(a)}catch(h){core.material.bgms[a]=null}};b.ontimeout=function(b){core.material.bgms[a]=null};b.onerror=function(b){core.material.bgms[a]=null};b.send()}else core.material.bgms[a]=null;else b=new Audio,b.preload=core.musicStatus.startDirectly?"auto":"none",b.src="sounds/"+a,b.loop="loop",core.material.bgms[a]=b});core.sounds.forEach(function(a){if(null!=core.musicStatus.audioContext){var b=new XMLHttpRequest;b.open("GET","sounds/"+a,!0);
b.responseType="arraybuffer";b.onload=function(b){try{core.musicStatus.audioContext.decodeAudioData(this.response,function(b){core.material.sounds[a]=b},function(b){core.material.sounds[a]=null})}catch(e){core.material.sounds[a]=null}};b.ontimeout=function(b){core.material.sounds[a]=null};b.onerror=function(b){core.material.sounds[a]=null};b.send()}else b=new Audio,b.src="sounds/"+a,core.material.sounds[a]=b});core.musicStatus.startDirectly&&0<core.bgms.length&&core.playBgm(core.bgms[0]);a()};
core.prototype.isPlaying=function(){return core.isset(core.status.played)&&core.status.played?!0:!1};core.prototype.clearStatus=function(){for(var a in core.interval)clearInterval(core.interval[a]);core.status={};core.clearStatusBar();core.resize(main.dom.body.clientWidth,main.dom.body.clientHeight)};
core.prototype.resetStatus=function(a,b,c,d,e){for(var f in core.interval)clearInterval(core.interval[f]);core.status=core.clone(core.initStatus);core.status.played=!0;core.status.floorId=c;core.status.maps=core.clone(e);core.material.enemys=core.clone(core.enemys.getEnemys());core.status.hero=core.clone(a);core.status.hard=b;core.isset(d)&&(core.status.route=d);core.status.saveIndex=core.getLocalStorage("saveIndex2",1);core.resize(main.dom.body.clientWidth,main.dom.body.clientHeight)};
core.prototype.startGame=function(a,b){core.resetStatus(core.firstData.hero,a,core.firstData.floorId,null,core.initStatus.maps);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){core.isset(b)&&b()});setTimeout(function(){var b=new FormData;b.append("type","people");b.append("name",core.firstData.name);b.append("version",core.firstData.version);b.append("platform",core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"");b.append("hard",
a);b.append("hardCode",core.getFlag("hard",0));var d=new XMLHttpRequest;d.open("POST","/games/upload.php");d.send(b)})};core.prototype.restart=function(){core.showStartAnimate()};
core.prototype.onkeyDown=function(a){if(!core.isset(core.status.replay)||!core.status.replay.replaying)if(core.isset(core.status.holdingKeys)||(core.status.holdingKeys=[]),{37:!0,38:!0,39:!0,40:!0}[a.keyCode]&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++)if(core.status.holdingKeys[b]===a.keyCode)return;core.status.holdingKeys.push(a.keyCode);core.pressKey(a.keyCode)}else core.keyDown(a.keyCode)};
core.prototype.onkeyUp=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying)27==a.keyCode?core.stopReplay():90==a.keyCode?core.rewindReplay():88==a.keyCode?core.forwardReplay():32==a.keyCode&&core.triggerReplay();else{if({37:!0,38:!0,39:!0,40:!0}[a.keyCode]&&!core.status.lockControl)for(var b=0;b<core.status.holdingKeys.length;b++)if(core.status.holdingKeys[b]===a.keyCode){core.status.holdingKeys=core.status.holdingKeys.slice(0,b).concat(core.status.holdingKeys.slice(b+1));
b===core.status.holdingKeys.length&&0!==core.status.holdingKeys.length&&core.pressKey(core.status.holdingKeys.slice(-1)[0]);break}core.keyUp(a.keyCode)}};core.prototype.pressKey=function(a){core.isset(core.status.replay)&&core.status.replay.replaying||a!==core.status.holdingKeys.slice(-1)[0]||(core.keyDown(a),window.setTimeout(function(){core.pressKey(a)},30))};
core.prototype.keyDown=function(a){if(!core.isset(core.status.replay)||!core.status.replay.replaying)if(core.status.lockControl)17==a?core.events.keyDownCtrl():"action"==core.status.event.id?core.events.keyDownAction(a):"book"==core.status.event.id?core.events.keyDownBook(a):"fly"==core.status.event.id?core.events.keyDownFly(a):"viewMaps"==core.status.event.id?core.events.keyDownViewMaps(a):"shop"==core.status.event.id?core.events.keyDownShop(a):"selectShop"==core.status.event.id?core.events.keyDownQuickShop(a):
"toolbox"==core.status.event.id?core.events.keyDownToolbox(a):"save"==core.status.event.id||"load"==core.status.event.id?core.events.keyDownSL(a):"switchs"==core.status.event.id?core.events.keyDownSwitchs(a):"settings"==core.status.event.id?core.events.keyDownSettings(a):"syncSave"==core.status.event.id?core.events.keyDownSyncSave(a):"syncSelect"==core.status.event.id?core.events.keyDownSyncSelect(a):"localSaveSelect"==core.status.event.id?core.events.keyDownLocalSaveSelect(a):"cursor"==core.status.event.id&&
core.events.keyDownCursor(a);else if(core.status.played){switch(a){case 37:core.moveHero("left");break;case 38:core.moveHero("up");break;case 39:core.moveHero("right");break;case 40:core.moveHero("down");break;case 13:case 32:case 67:case 51:core.status.heroStop&&core.hasItem("centerFly")&&(core.status.usingCenterFly?(core.canUseItem("centerFly")?(core.useItem("centerFly"),core.clearMap("ui",32*core.getHeroLoc("x"),32*core.getHeroLoc("y"),32,32)):(core.drawTip("\u5f53\u524d\u4e0d\u80fd\u4f7f\u7528\u4e2d\u5fc3\u5bf9\u79f0\u98de\u884c\u5668"),
core.clearMap("ui",32*(12-core.getHeroLoc("x")),32*(12-core.getHeroLoc("y")),32,32)),core.status.usingCenterFly=!1):51==a&&(core.status.usingCenterFly=!0,core.setAlpha("ui",.5),core.fillRect("ui",32*(12-core.getHeroLoc("x")),32*(12-core.getHeroLoc("y")),32,32,core.canUseItem("centerFly")?"#00FF00":"#FF0000"),core.setAlpha("ui",1),core.drawTip("\u8bf7\u786e\u8ba4\u5f53\u524d\u4e2d\u5fc3\u5bf9\u79f0\u98de\u884c\u5668\u7684\u4f4d\u7f6e")))}core.status.usingCenterFly&&51!=a&&(core.clearMap("ui",32*(12-
core.getHeroLoc("x")),32*(12-core.getHeroLoc("y")),32,32),core.status.usingCenterFly=!1)}};
core.prototype.keyUp=function(a){if(!core.isset(core.status.replay)||!core.status.replay.replaying)if(core.status.lockControl)core.status.holdingKeys=[],"text"!=core.status.event.id||13!=a&&32!=a&&67!=a?"confirmBox"==core.status.event.id?core.events.keyUpConfirmBox(a):"action"==core.status.event.id?core.events.keyUpAction(a):"about"!=core.status.event.id||13!=a&&32!=a&&67!=a?"book"==core.status.event.id?core.events.keyUpBook(a):"book-detail"!=core.status.event.id||13!=a&&32!=a&&67!=a?"fly"==core.status.event.id?
core.events.keyUpFly(a):"viewMaps"==core.status.event.id?core.events.keyUpViewMaps(a):"shop"==core.status.event.id?core.events.keyUpShop(a):"selectShop"==core.status.event.id?core.events.keyUpQuickShop(a):"toolbox"==core.status.event.id?core.events.keyUpToolbox(a):"save"==core.status.event.id||"load"==core.status.event.id?core.events.keyUpSL(a):"switchs"==core.status.event.id?core.events.keyUpSwitchs(a):"settings"==core.status.event.id?core.events.keyUpSettings(a):"syncSave"==core.status.event.id?
core.events.keyUpSyncSave(a):"syncSelect"==core.status.event.id?core.events.keyUpSyncSelect(a):"localSaveSelect"==core.status.event.id?core.events.keyUpLocalSaveSelect(a):"cursor"==core.status.event.id&&core.events.keyUpCursor(a):core.events.clickBookDetail():core.events.clickAbout():core.drawText();else if(core.status.played){switch(a){case 27:core.status.heroStop&&core.openSettings(!0);break;case 71:core.status.heroStop&&core.useFly(!0);break;case 88:core.status.heroStop&&core.openBook(!0);break;
case 65:core.doSL("autoSave","load");break;case 83:core.status.heroStop&&core.save(!0);break;case 68:core.status.heroStop&&core.load(!0);break;case 69:core.status.heroStop&&core.ui.drawCursor();break;case 84:core.status.heroStop&&core.openToolbox(!0);break;case 90:core.status.heroStop&&core.turnHero();break;case 75:core.status.heroStop&&core.openQuickShop(!0);break;case 32:!core.status.lockControl&&core.status.heroStop&&core.getNextItem();break;case 72:!core.status.lockControl&&core.status.heroStop&&
core.ui.drawHelp();break;case 82:!core.status.lockControl&&core.status.heroStop&&core.ui.drawConfirmBox("\u786e\u5b9a\u8981\u56de\u653e\u5f55\u50cf\u5417\uff1f",function(){core.ui.closePanel();var a=core.status.hard,c=core.clone(core.status.route);core.resetStatus(core.firstData.hero,a,core.firstData.floorId,null,core.initStatus.maps);core.events.setInitData(a);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){core.startReplay(c)})},function(){core.ui.closePanel()});
break;case 33:case 34:core.status.heroStop&&(core.flags.enableViewMaps?core.ui.drawMaps(core.floorIds.indexOf(core.status.floorId)):core.drawTip("\u672c\u5854\u4e0d\u5141\u8bb8\u6d4f\u89c8\u5730\u56fe\uff01"));break;case 49:core.status.heroStop&&core.hasItem("pickaxe")&&(core.canUseItem("pickaxe")?core.useItem("pickaxe"):core.drawTip("\u5f53\u524d\u4e0d\u80fd\u4f7f\u7528\u7834\u5899\u9550"));break;case 50:core.status.heroStop&&(core.hasItem("bomb")?core.canUseItem("bomb")?core.useItem("bomb"):core.drawTip("\u5f53\u524d\u4e0d\u80fd\u4f7f\u7528\u70b8\u5f39"):
core.hasItem("hammer")&&(core.canUseItem("hammer")?core.useItem("hammer"):core.drawTip("\u5f53\u524d\u4e0d\u80fd\u4f7f\u7528\u5723\u9524")))}core.isset(core.status.automaticRoute)&&core.status.automaticRoute.autoHeroMove&&core.stopAutomaticRoute();core.stopHero()}};
core.prototype.ondown=function(a,b){if(!core.isset(core.status.replay)||!core.status.replay.replaying)if(!core.status.played||core.status.lockControl)core.onclick(a,b,[]);else core.status.downTime=new Date,core.saveCanvas("ui"),core.clearMap("ui",0,0,416,416),a={x:a,y:b},core.status.stepPostfix=[],core.status.stepPostfix.push(a),core.fillPosWithPoint(a)};
core.prototype.onmove=function(a,b){if(!core.isset(core.status.replay)||!core.status.replay.replaying){b={x:a,y:b};a=core.status.stepPostfix[core.status.stepPostfix.length-1];b=[b.y-a.y,a.x-b.x,a.y-b.y,b.x-a.x];for(var c=0,d=4,e=0;4>e;e++)b[e]>c&&(d=e,c=b[e]);if(b=[{x:0,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:0},!1][d])b.x+=a.x,b.y+=a.y,core.status.stepPostfix.push(b),core.fillPosWithPoint(b)}};
core.prototype.onup=function(){if((!core.isset(core.status.replay)||!core.status.replay.replaying)&&0<core.status.stepPostfix.length){for(var a=[],b={0:{1:"down","-1":"up"},"-1":{0:"left"},1:{0:"right"}},c=1;c<core.status.stepPostfix.length;c++){var d=core.status.stepPostfix[c-1],e=core.status.stepPostfix[c];a.push({direction:b[e.x-d.x][e.y-d.y],x:e.x,y:e.y})}b=core.status.stepPostfix[0].x;c=core.status.stepPostfix[0].y;core.status.stepPostfix=[];core.status.lockControl||(core.canvas.ui.clearRect(0,
0,416,416),core.canvas.ui.restore());if(!core.status.lockControl&&0==a.length&&null!=core.status.downTime&&1E3<=new Date-core.status.downTime)core.events.longClick();else core.onclick(b,c,a);core.status.downTime=null}};
core.prototype.getClickLoc=function(a,b){var c=0,d=0;var e=32*core.domStyle.scale;switch(core.domStyle.screenMode){case "vertical":c=0;d=core.dom.statusBar.offsetHeight+3;break;case "horizontal":case "bigScreen":c=core.dom.statusBar.offsetWidth+3,d=0}return{x:a-(core.dom.gameGroup.offsetLeft+c),y:b-(core.dom.gameGroup.offsetTop+d),size:e}};
core.prototype.onclick=function(a,b,c){if(!core.isset(core.status.replay)||!core.status.replay.replaying)if(c=c||[],!(0>a||0>b||12<a||12<b)){if(core.status.usingCenterFly){if(a==12-core.getHeroLoc("x")&&b==12-core.getHeroLoc("y")){if(core.canUseItem("centerFly")){core.useItem("centerFly");core.clearMap("ui",32*core.getHeroLoc("x"),32*core.getHeroLoc("y"),32,32);return}core.drawTip("\u5f53\u524d\u4e0d\u80fd\u4f7f\u7528\u4e2d\u5fc3\u5bf9\u79f0\u98de\u884c\u5668")}core.clearMap("ui",32*(12-core.getHeroLoc("x")),
32*(12-core.getHeroLoc("y")),32,32);core.status.usingCenterFly=!1}core.status.lockControl?"book"==core.status.event.id?core.events.clickBook(a,b):"book-detail"==core.status.event.id?core.events.clickBookDetail(a,b):"fly"==core.status.event.id?core.events.clickFly(a,b):"viewMaps"==core.status.event.id?core.events.clickViewMaps(a,b):"switchs"==core.status.event.id?core.events.clickSwitchs(a,b):"settings"==core.status.event.id?core.events.clickSettings(a,b):"shop"==core.status.event.id?core.events.clickShop(a,
b):"selectShop"==core.status.event.id?core.events.clickQuickShop(a,b):"toolbox"==core.status.event.id?core.events.clickToolbox(a,b):"save"==core.status.event.id||"load"==core.status.event.id?core.events.clickSL(a,b):"confirmBox"==core.status.event.id?core.events.clickConfirmBox(a,b):"keyBoard"==core.status.event.id?core.events.clickKeyBoard(a,b):"about"==core.status.event.id?core.events.clickAbout(a,b):"action"==core.status.event.id?core.events.clickAction(a,b):"text"==core.status.event.id?core.drawText():
"syncSave"==core.status.event.id?core.events.clickSyncSave(a,b):"syncSelect"==core.status.event.id?core.events.clickSyncSelect(a,b):"localSaveSelect"==core.status.event.id?core.events.clickLocalSaveSelect(a,b):"cursor"==core.status.event.id&&core.events.clickCursor(a,b):core.setAutomaticRoute(a,b,c)}};
core.prototype.onmousewheel=function(a){core.isset(core.status.replay)&&core.status.replay.replaying||(core.status.lockControl&&"fly"==core.status.event.id?(1==a&&core.ui.drawFly(core.status.event.data+1),-1==a&&core.ui.drawFly(core.status.event.data-1)):core.status.lockControl&&"book"==core.status.event.id?(1==a&&core.ui.drawBook(core.status.event.data-6),-1==a&&core.ui.drawBook(core.status.event.data+6)):!core.status.lockControl||"save"!=core.status.event.id&&"load"!=core.status.event.id?core.status.lockControl&&
"viewMaps"==core.status.event.id&&(1==a&&core.ui.drawMaps(core.status.event.data+1),-1==a&&core.ui.drawMaps(core.status.event.data-1)):(1==a&&core.ui.drawSLPanel(core.status.event.data-10),-1==a&&core.ui.drawSLPanel(core.status.event.data+10)))};core.prototype.clearAutomaticRouteNode=function(a,b){null==core.status.event.id&&core.canvas.ui.clearRect(32*a+5,32*b+5,27,27)};
core.prototype.stopAutomaticRoute=function(){core.status.played&&(core.status.automaticRoute.autoHeroMove=!1,core.status.automaticRoute.autoStep=0,core.status.automaticRoute.destStep=0,core.status.automaticRoute.movedStep=0,core.status.automaticRoute.autoStepRoutes=[],core.status.automaticRoute.destX=null,core.status.automaticRoute.destY=null,core.status.automaticRoute.lastDirection=null,core.stopHero(),0==core.status.automaticRoute.moveStepBeforeStop.length&&core.canvas.ui.clearRect(0,0,416,416))};
core.prototype.continueAutomaticRoute=function(){var a=core.status.automaticRoute.moveStepBeforeStop;0===a.length||1===a.length&&1===a[0].step?core.status.automaticRoute.moveStepBeforeStop=[]:core.setAutoHeroMove(a)};core.prototype.clearContinueAutomaticRoute=function(){core.canvas.ui.clearRect(0,0,416,416);core.status.automaticRoute.moveStepBeforeStop=[]};
core.prototype.setAutomaticRoute=function(a,b,c){if(core.status.played&&!core.status.lockControl)if(core.status.automaticRoute.autoHeroMove){var d=core.status.automaticRoute.destX,e=core.status.automaticRoute.destY;core.stopAutomaticRoute();d==a&&e==b&&(core.status.automaticRoute.moveDirectly=!0,setTimeout(function(){core.status.automaticRoute.moveDirectly&&core.canMoveDirectly(a,b)&&(core.clearMap("hero",0,0,416,416),core.setHeroLoc("x",a),core.setHeroLoc("y",b),core.drawHero(core.getHeroLoc("direction"),
core.getHeroLoc("x"),core.getHeroLoc("y"),"stop"),core.status.route.push("move:"+a+":"+b));core.status.automaticRoute.moveDirectly=!1},100))}else if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y&&0==c.length)null==core.timeout.turnHeroTimeout?core.timeout.turnHeroTimeout=setTimeout(function(){core.turnHero();clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null},250):(clearTimeout(core.timeout.turnHeroTimeout),core.timeout.turnHeroTimeout=null,core.getNextItem());else{d=
0;e=null;var f;if(!(f=core.automaticRoute(a,b)))if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y)f=[];else{core.canvas.ui.clearRect(0,0,416,416);return}f=f.concat(c);core.status.automaticRoute.destX=a;core.status.automaticRoute.destY=b;core.canvas.ui.save();core.canvas.ui.clearRect(0,0,416,416);core.canvas.ui.fillStyle="#bfbfbf";core.canvas.ui.strokeStyle="#bfbfbf";core.canvas.ui.lineWidth=8;for(c=0;c<f.length;c++)if(null==e?(d++,e=f[c].direction):e==f[c].direction?d++:(core.status.automaticRoute.autoStepRoutes.push({direction:e,
step:d}),d=1,e=f[c].direction),c==f.length-1)core.status.automaticRoute.autoStepRoutes.push({direction:e,step:d}),core.canvas.ui.fillRect(32*f[c].x+10,32*f[c].y+10,12,12);else if(core.canvas.ui.beginPath(),core.isset(f[c+1])&&e!=f[c+1].direction){if("up"==e&&"left"==f[c+1].direction||"right"==e&&"down"==f[c+1].direction)core.canvas.ui.moveTo(32*f[c].x+5,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+27);else if("up"==e&&"right"==f[c+1].direction||
"left"==e&&"down"==f[c+1].direction)core.canvas.ui.moveTo(32*f[c].x+27,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+27);else if("left"==e&&"up"==f[c+1].direction||"down"==e&&"right"==f[c+1].direction)core.canvas.ui.moveTo(32*f[c].x+27,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+5);else if("right"==e&&"up"==f[c+1].direction||"down"==e&&"left"==f[c+1].direction)core.canvas.ui.moveTo(32*
f[c].x+5,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+5);core.canvas.ui.stroke()}else switch(e){case "up":case "down":core.canvas.ui.beginPath();core.canvas.ui.moveTo(32*f[c].x+16,32*f[c].y+5);core.canvas.ui.lineTo(32*f[c].x+16,32*f[c].y+27);core.canvas.ui.stroke();break;case "left":case "right":core.canvas.ui.beginPath(),core.canvas.ui.moveTo(32*f[c].x+5,32*f[c].y+16),core.canvas.ui.lineTo(32*f[c].x+27,32*f[c].y+16),core.canvas.ui.stroke()}core.canvas.ui.restore();
core.setAutoHeroMove()}};
core.prototype.automaticRoute=function(a,b){var c=core.getHeroLoc("x"),d=core.getHeroLoc("y"),e={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}},f=[],g=0,h=[],k=[];if(a==c&&b==d)return!1;f.push(13*c+d);f.push(-1);for(h[13*c+d]="";1!=f.length;){var m=f.shift();if(-1===m)g+=1,f.push(-1);else if(~~(m/169)!==g)f.push(m);else{m%=169;var l=parseInt(m/13);m%=13;core.getBlock(l,m);for(var n in e)if(core.canMoveHero(l,m,n)){var p=l+e[n].x,r=m+e[n].y;if(!(0>p||12<p||0>r||12<r)){var t=13*p+r;if(!core.isset(h[t])){var q=
1,u=core.getBlock(p,r);if(null!=u){var v=u.block.event.id;"light"==v&&(q=100);"Net"==v.substring(v.length-3)&&(q=core.values.lavaDamage);core.flags.potionWhileRouting||"Potion"!=v.substring(v.length-6)||(q=20);"changeFloor"==u.block.event.trigger&&(q=10)}0<core.status.checkBlock.damage[t]&&(q=core.status.checkBlock.damage[t]);if(p==a&&r==b){h[t]=n;break}core.noPassExists(p,r)||(h[t]=n,f.push(169*(g+q)+t))}}}if(core.isset(h[13*a+b]))break}}if(!core.isset(h[13*a+b]))return!1;l=a;for(m=b;l!=c||m!=d;)a=
h[13*l+m],k.push({direction:a,x:l,y:m}),l-=e[a].x,m-=e[a].y;k.reverse();return k};core.prototype.fillPosWithPoint=function(a){core.fillRect("ui",32*a.x+12,32*a.y+12,8,8,"#bfbfbf")};core.prototype.setAutoHeroMove=function(a){a=a||core.status.automaticRoute.autoStepRoutes;0!=a.length&&(core.status.automaticRoute.autoStepRoutes=a,core.status.automaticRoute.autoHeroMove=!0,core.status.automaticRoute.autoStep=1,core.status.automaticRoute.destStep=a[0].step,core.moveHero(a[0].direction))};
core.prototype.setHeroMoveInterval=function(a,b,c,d){if(!(0<core.status.heroMoving)){core.status.heroMoving=1;var e={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};core.interval.heroMoveInterval=window.setInterval(function(){core.status.heroMoving++;8==core.status.heroMoving&&(core.setHeroLoc("x",b+e[a].x),core.setHeroLoc("y",c+e[a].y),core.moveOneStep(),core.clearMap("hero",0,0,416,416),core.drawHero(a,core.getHeroLoc("x"),core.getHeroLoc("y"),"stop"),clearInterval(core.interval.heroMoveInterval),
core.status.heroMoving=0,core.isset(d)&&d())},12.5/core.status.replay.speed)}};
core.prototype.moveAction=function(a){if(null==core.interval.openDoorAnimate&&!(0<core.status.heroMoving)){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}},c=core.getHeroLoc("direction"),d=core.getHeroLoc("x"),e=core.getHeroLoc("y"),f=core.noPass(d+b[c].x,e+b[c].y),g=core.canMoveHero();f||!g?("ski"!=core.status.event.id&&core.status.route.push(c),core.status.automaticRoute.moveStepBeforeStop=[],g&&core.trigger(d+b[c].x,e+b[c].y),core.drawHero(c,d,e,"stop"),0==core.status.automaticRoute.moveStepBeforeStop.length&&
(core.clearContinueAutomaticRoute(),core.stopAutomaticRoute()),core.isset(a)&&a()):core.setHeroMoveInterval(c,d,e,function(){core.status.automaticRoute.autoHeroMove?(core.status.automaticRoute.movedStep++,core.status.automaticRoute.lastDirection=core.getHeroLoc("direction"),core.status.automaticRoute.destStep==core.status.automaticRoute.movedStep&&(core.status.automaticRoute.autoStep==core.status.automaticRoute.autoStepRoutes.length?(core.clearContinueAutomaticRoute(),core.stopAutomaticRoute()):(core.status.automaticRoute.movedStep=
0,core.status.automaticRoute.destStep=core.status.automaticRoute.autoStepRoutes[core.status.automaticRoute.autoStep].step,core.setHeroLoc("direction",core.status.automaticRoute.autoStepRoutes[core.status.automaticRoute.autoStep].direction),core.status.automaticRoute.autoStep++))):core.status.heroStop&&core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");"ski"!=core.status.event.id&&core.status.route.push(c);core.trigger(core.getHeroLoc("x"),core.getHeroLoc("y"));
core.checkBlock();core.isset(a)&&a()})}};
core.prototype.turnHero=function(){"up"==core.status.hero.loc.direction?core.status.hero.loc.direction="right":"right"==core.status.hero.loc.direction?core.status.hero.loc.direction="down":"down"==core.status.hero.loc.direction?core.status.hero.loc.direction="left":"left"==core.status.hero.loc.direction&&(core.status.hero.loc.direction="up");core.drawHero(core.status.hero.loc.direction,core.status.hero.loc.x,core.status.hero.loc.y,"stop",0,0);core.canvas.ui.clearRect(0,0,416,416);core.status.route.push("turn")};
core.prototype.canMoveHero=function(a,b,c,d){core.isset(a)||(a=core.getHeroLoc("x"));core.isset(b)||(b=core.getHeroLoc("y"));core.isset(c)||(c=core.getHeroLoc("direction"));core.isset(d)||(d=core.status.floorId);if(core.isset(core.floors[d].cannotMove)){var e=core.floors[d].cannotMove[a+","+b];if(core.isset(e)&&e instanceof Array&&0<=e.indexOf(c))return!1}e=core.getBlock(a,b,d);if(null!=e&&(nowId=e.block.event.id,"arrow"==nowId.slice(0,5).toLowerCase()&&(e=nowId.slice(5).toLowerCase(),c!=e)))return!1;
e={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};a=core.getBlock(a+e[c].x,b+e[c].y,d);return null!=a&&(nextId=a.block.event.id,"arrow"==nextId.slice(0,5).toLowerCase()&&(a=nextId.slice(5).toLowerCase(),0==e[c].x+e[a].x&&0==e[c].y+e[a].y))?!1:!0};
core.prototype.canMoveDirectly=function(a,b){if(!core.flags.enableMoveDirectly||core.hasFlag("poison"))return!1;var c=core.getHeroLoc("x"),d=core.getHeroLoc("y");if(c==a&&d==b||null!=core.getBlock(c,d)||0<core.status.checkBlock.damage[13*c+d])return!1;var e=[],f=[];e[13*c+d]=!0;f.push(13*c+d);for(c=[[-1,0],[1,0],[0,1],[0,-1]];0<f.length;){var g=f.shift();d=parseInt(g/13);g%=13;for(var h in c){var k=d+c[h][0],m=g+c[h][1];if(!(0>k||13<=k||0>m||13<=m||e[13*k+m]||null!=core.getBlock(k,m)||0<core.status.checkBlock.damage[13*
k+m])){if(k==a&&m==b)return!0;e[13*k+m]=!0;f.push(13*k+m)}}}return!1};core.prototype.moveHero=function(a,b){if(!(0<core.status.heroMoving))if(core.isset(a)&&core.setHeroLoc("direction",a),core.isset(b))core.moveAction(function(){b()});else{core.status.heroStop=!1;core.status.automaticRoute.moveDirectly=!1;var c=function(){core.status.heroStop?core.stopHero():(core.moveAction(),setTimeout(c,50))};c()}};
core.prototype.eventMoveHero=function(a,b,c){b=b||100;core.clearMap("ui",0,0,416,416);core.setAlpha("ui",1);var d=[];a.forEach(function(a){if("string"==typeof a)d.push(a);else if(core.isset(a.value))for(var b=0;b<a.value;b++)d.push(a.direction);else d.push(a.direction)});var e=0,f={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};core.status.replay.animate=!0;var g=window.setInterval(function(){var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");if(0==d.length)clearInterval(g),core.drawHero(core.getHeroLoc("direction"),
a,b,"stop"),core.status.replay.animate=!1,core.isset(c)&&c();else{var m=d[0];core.setHeroLoc("direction",m);e++;4>=e?core.drawHero(m,a,b,"leftFoot",4*e*f[m].x,4*e*f[m].y):8>=e&&core.drawHero(m,a,b,"rightFoot",4*e*f[m].x,4*e*f[m].y);8==e&&(e=0,core.setHeroLoc("x",a+f[m].x),core.setHeroLoc("y",b+f[m].y),d.shift())}},b/8/core.status.replay.speed)};
core.prototype.moveOneStep=function(){core.status.hero.steps++;core.hasFlag("poison")&&(core.status.hero.hp-=core.values.poisonDamage,0>=core.status.hero.hp?(core.status.hero.hp=0,core.updateStatusBar(),core.events.lose("poison")):core.updateStatusBar())};
core.prototype.waitHeroToStop=function(a){core.stopAutomaticRoute();core.clearContinueAutomaticRoute();core.isset(a)&&(core.status.replay.animate=!0,core.lockControl(),core.status.automaticRoute.moveDirectly=!1,setTimeout(function(){core.status.replay.animate=!1;core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");a()},30))};core.prototype.stopHero=function(){core.status.heroStop=!0};
core.prototype.drawHero=function(a,b,c,d,e,f){e=e||0;f=f||0;core.clearAutomaticRouteNode(b+(0==e?0:e/Math.abs(e)),c+(0==f?0:f/Math.abs(f)));a=core.material.icons.hero[a];b*=32;c*=32;core.canvas.hero.clearRect(b-32,c-32,96,96);var g=core.material.icons.hero.height;core.canvas.hero.drawImage(core.material.images.hero,32*a[d],a.loc*g,32,g,b+e,c+f+32-g,32,g)};core.prototype.setHeroLoc=function(a,b){"++"==b?core.status.hero.loc[a]++:"--"==b?core.status.hero.loc[a]--:core.status.hero.loc[a]=b};
core.prototype.getHeroLoc=function(a){return core.isset(a)?core.status.hero.loc[a]:core.status.hero.loc};core.prototype.nextX=function(){return core.getHeroLoc("x")+{up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}}[core.getHeroLoc("direction")].x};core.prototype.nextY=function(){return core.getHeroLoc("y")+{up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}}[core.getHeroLoc("direction")].y};
core.prototype.openDoor=function(a,b,c,d,e){if(null==core.interval.openDoorAnimate)if(core.terrainExists(b,c,a)){0==core.status.automaticRoute.moveStepBeforeStop.length&&(core.status.automaticRoute.moveStepBeforeStop=core.status.automaticRoute.autoStepRoutes.slice(core.status.automaticRoute.autoStep-1,core.status.automaticRoute.autoStepRoutes.length),1<=core.status.automaticRoute.moveStepBeforeStop.length&&(core.status.automaticRoute.moveStepBeforeStop[0].step-=core.status.automaticRoute.movedStep));
core.stopAutomaticRoute();var f=30;if(d){d=a.replace("Door","Key");if(!core.hasItem(d)){"specialKey"!=d?core.drawTip("\u4f60\u6ca1\u6709"+core.material.items[d].name):core.drawTip("\u65e0\u6cd5\u5f00\u542f\u6b64\u95e8");core.clearContinueAutomaticRoute();return}core.autosave(!0);core.removeItem(d)}core.playSound("door.ogg");var g=0;d=a;"Door"!=d.substring(d.length-4)&&(d+="Door",f=100);var h=core.material.icons.animates[d];core.status.replay.animate=!0;core.interval.openDoorAnimate=window.setInterval(function(){g++;
4==g?(clearInterval(core.interval.openDoorAnimate),core.interval.openDoorAnimate=null,core.removeBlock(b,c),core.status.replay.animate=!1,core.events.afterOpenDoor(a,b,c,e)):(core.canvas.event.clearRect(32*b,32*c,32,32),core.canvas.event.drawImage(core.material.images.animates,32*g,32*h,32,32,32*b,32*c,32,32))},f)}else core.isset(e)&&e()};
core.prototype.battle=function(a,b,c,d,e){0==core.status.automaticRoute.moveStepBeforeStop.length&&(core.status.automaticRoute.moveStepBeforeStop=core.status.automaticRoute.autoStepRoutes.slice(core.status.automaticRoute.autoStep-1,core.status.automaticRoute.autoStepRoutes.length),1<=core.status.automaticRoute.moveStepBeforeStop.length&&(core.status.automaticRoute.moveStepBeforeStop[0].step-=core.status.automaticRoute.movedStep));core.stopHero();core.stopAutomaticRoute();core.enemys.getDamage(a)>=
core.status.hero.hp&&!d?(core.drawTip("\u4f60\u6253\u4e0d\u8fc7\u6b64\u602a\u7269\uff01"),core.clearContinueAutomaticRoute()):(core.isset(core.status.event.id)||core.autosave(!0),core.flags.battleAnimate&&!core.status.replay.replaying?core.waitHeroToStop(function(){core.ui.drawBattleAnimate(a,function(){core.afterBattle(a,b,c,e)})}):(core.flags.equipment&&"sword0"!=core.getFlag("sword","sword0")?(core.playSound("zone.ogg"),core.drawAnimate("sword",b,c)):(core.playSound("attack.ogg"),core.drawAnimate("hand",
b,c)),core.afterBattle(a,b,c,e)))};
core.prototype.afterBattle=function(a,b,c,d){core.status.hero.hp-=core.enemys.getDamage(a);if(0>=core.status.hero.hp)core.status.hero.hp=0,core.updateStatusBar(),core.events.lose("battle");else{var e=core.material.enemys[a].money;core.hasItem("coin")&&(e*=2);core.hasFlag("curse")&&(e=0);core.status.hero.money+=e;var f=core.material.enemys[a].experience;core.hasFlag("curse")&&(f=0);core.status.hero.experience+=f;core.isset(b)&&core.isset(c)&&(core.removeBlock(b,c),core.canvas.event.clearRect(32*b,
32*c,32,32));var g="\u6253\u8d25 "+core.material.enemys[a].name;core.flags.enableMoney&&(g+="\uff0c\u91d1\u5e01+"+e);core.flags.enableExperience&&(g+="\uff0c\u7ecf\u9a8c+"+f);core.drawTip(g);core.events.afterBattle(a,b,c,d)}};
core.prototype.trigger=function(a,b){for(var c=core.status.thisMap.blocks,d,e=0;e<c.length;e++)if(c[e].x==a&&c[e].y==b&&(!core.isset(c[e].enable)||c[e].enable)&&((d=c[e].event&&c[e].event.noPass)&&core.clearAutomaticRouteNode(a,b),core.isset(c[e].event)&&core.isset(c[e].event.trigger))){var f=c[e].event.trigger;if("changeFloor"==f&&!d&&(d=core.flags.portalWithoutTrigger,core.isset(c[e].event.data)&&core.isset(c[e].event.data.portalWithoutTrigger)&&(d=c[e].event.data.portalWithoutTrigger),d))if(core.status.replay.replaying){if("no"==
core.status.replay.toReplay[0]){core.status.replay.toReplay.shift();core.status.route.push("no");continue}}else if(core.status.automaticRoute.autoHeroMove||core.status.automaticRoute.autoStep<core.status.automaticRoute.autoStepRoutes.length){core.status.route.push("no");continue}core.status.automaticRoute.moveDirectly=!1;core.material.events[f](c[e],core,function(a){})}};
core.prototype.changeFloor=function(a,b,c,d,e){var f=0!=d&&!core.status.replay.replaying;d=d||800;d/=20;core.lockControl();core.stopHero();core.stopAutomaticRoute();core.clearContinueAutomaticRoute();core.status.replay.animate=!0;core.dom.floorNameLabel.innerHTML=core.status.maps[a].title;core.isset(b)||core.isset(c)||(c=core.status.hero.loc);if(core.isset(b)){core.isset(c)||(c={});var g=core.status.maps[a].blocks,h;for(h in g)if(core.isset(g[h].event)&&(!core.isset(g[h].enable)||g[h].enable)&&g[h].event.id===
b){c.x=g[h].x;c.y=g[h].y;break}core.isset(c.x)||(c.x=core.status.hero.loc.x,c.y=core.status.hero.loc.y)}core.status.maps[a].canFlyTo&&0>core.status.hero.flyRange.indexOf(a)&&(core.floorIds.indexOf(a)>core.floorIds.indexOf(core.status.floorId)?core.status.hero.flyRange.push(a):core.status.hero.flyRange.unshift(a));window.setTimeout(function(){var b=function(){var b=core.status.maps[a].name;core.isset(b)&&""!=b||(b="&nbsp;");core.statusBar.floor.innerHTML=b;/^[+-]?\d+$/.test(b)?core.statusBar.floor.style.fontStyle=
"italic":core.statusBar.floor.style.fontStyle="normal";core.isset(core.floors[a].bgm)&&core.playBgm(core.floors[a].bgm);null==core.status.event.id&&(core.isset(core.floors[a].color)?(b=core.floors[a].color,core.dom.curtain.style.background=core.arrayToRGB(b),core.isset(b[3])?core.dom.curtain.style.opacity=b[3]:core.dom.curtain.style.opacity=1,core.status.curtainColor=b):(core.dom.curtain.style.background="#000000",core.dom.curtain.style.opacity=0));core.isset(core.floors[a].weather)?core.setWeather(core.floors[a].weather[0],
core.floors[a].weather[1]):core.setWeather();core.drawMap(a,function(){setTimeout(function(){core.isset(c.direction)&&core.setHeroLoc("direction",c.direction);core.setHeroLoc("x",c.x);core.setHeroLoc("y",c.y);core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");core.updateStatusBar();var b=function(){core.unLockControl();core.status.replay.animate=!1;core.events.afterChangeFloor(a);core.isset(e)&&e()};f?core.mapChangeAnimate("hide",d/4,function(){b()}):b()},
25)})};core.playSound("floor.mp3");f?core.mapChangeAnimate("show",d/2,function(){b()}):b()},25)};core.prototype.mapChangeAnimate=function(a,b,c){"show"==a?core.show(core.dom.floorMsgGroup,b,function(){c()}):core.hide(core.dom.floorMsgGroup,b,function(){c()})};core.prototype.clearMap=function(a,b,c,d,e){if("all"==a)for(var f in core.canvas)core.canvas[f].clearRect(0,0,416,416);else core.canvas[a].clearRect(b,c,d,e)};
core.prototype.fillText=function(a,b,c,d,e,f){core.isset(e)&&core.setFillStyle(a,e);core.isset(f)&&core.setFont(a,f);core.canvas[a].fillText(b,c,d)};core.prototype.fillRect=function(a,b,c,d,e,f){core.isset(f)&&core.setFillStyle(a,f);core.canvas[a].fillRect(b,c,d,e)};core.prototype.strokeRect=function(a,b,c,d,e,f,g){core.isset(f)&&core.setStrokeStyle(a,f);core.isset(g)&&core.setLineWidth(a,g);core.canvas[a].strokeRect(b,c,d,e)};
core.prototype.drawLine=function(a,b,c,d,e,f,g){core.isset(f)&&core.setStrokeStyle(a,f);core.isset(g)&&core.setLineWidth(a,g);core.canvas[a].beginPath();core.canvas[a].moveTo(b,c);core.canvas[a].lineTo(d,e);core.canvas[a].closePath();core.canvas[a].stroke()};core.prototype.setFont=function(a,b){core.canvas[a].font=b};core.prototype.setLineWidth=function(a,b){if("all"==a)for(var c in core.canvas)core.canvas[c].lineWidth=b;core.canvas[a].lineWidth=b};core.prototype.saveCanvas=function(a){core.canvas[a].save()};
core.prototype.loadCanvas=function(a){core.canvas[a].restore()};core.prototype.setStrokeStyle=function(a,b){if("all"==a)for(var c in core.canvas)core.canvas[c].strokeStyle=b;else core.canvas[a].strokeStyle=b};core.prototype.setAlpha=function(a,b){if("all"==a)for(var c in core.canvas)core.canvas[c].globalAlpha=b;else core.canvas[a].globalAlpha=b};
core.prototype.setOpacity=function(a,b){if("all"==a)for(var c in core.canvas)core.canvas[c].canvas.style.opacity=b;else core.canvas[a].canvas.style.opacity=b};core.prototype.setFillStyle=function(a,b){if("all"==a)for(var c in core.canvas)core.canvas[c].fillStyle=b;else core.canvas[a].fillStyle=b};
core.prototype.drawMap=function(a,b){var c=core.status.maps[a],d=c.blocks;core.status.floorId=a;core.status.thisMap=c;core.clearMap("all");core.removeGlobalAnimate(null,null,!0);c=core.material.icons.terrains[core.floors[a].defaultGround||"ground"];for(var e=core.material.images.terrains,f=0;13>f;f++)for(var g=0;13>g;g++)core.canvas.bg.drawImage(e,0,32*c,32,32,32*f,32*g,32,32);core.isset(core.floors[a].png)&&(g=f=0,c=core.floors[a].png,"string"==typeof c?core.isset(core.material.images.pngs[c])&&
core.canvas.bg.drawImage(core.material.images.pngs[c],f,g,416,416):c instanceof Array&&c.forEach(function(a){if(3==a.length){var b=parseInt(a[0]),c=parseInt(a[1]);a=a[2];core.isset(b)&&core.isset(c)&&core.isset(core.material.images.pngs[a])&&(b*=32,c*=32,a=core.material.images.pngs[a],core.canvas.bg.drawImage(a,f+1*b,g+1*c,Math.min(416-1*b,1*a.width),Math.min(416-1*c,1*a.height)))}}));a=core.maps.getMapArray(d);for(var h=0;h<d.length;h++){var k=d[h];!core.isset(k.event)||core.isset(k.enable)&&!k.enable||
("autotile"==k.event.cls?core.drawAutotile(core.canvas.event,a,k,32,0,0):"none"!=k.event.id&&(c=core.material.icons[k.event.cls][k.event.id],e=core.material.images[k.event.cls],core.canvas.event.drawImage(core.material.images[k.event.cls],0,32*c,32,32,32*k.x,32*k.y,32,32),core.addGlobalAnimate(k.event.animate,32*k.x,32*k.y,c,e)))}core.setGlobalAnimate(core.values.animateSpeed);core.isset(b)&&b()};
core.prototype.drawAutotile=function(a,b,c,d,e,f){var g=[[10,9,4,3],[10,9,4,13],[10,9,18,3],[10,9,16,15],[10,43,4,3],[10,31,4,25],[10,7,2,3],[10,31,16,5],[48,9,4,3],[8,9,4,1],[36,9,30,3],[36,9,6,15],[46,45,4,3],[46,11,4,25],[12,45,30,3],[34,33,28,27]],h=function(a,b,c,d,e,f){a.drawImage(d,(e-1)%6*16,16*~~((e-1)/6),16,16,b,c,f/2,f/2)},k=c.x,m=c.y,l=function(a,c){for(var d=[],e=b[c][a],f=[],h=0;4>h;h++){for(var k=0,m=h%2,l=~~(h/2),n=0;4>n;n++){var p=a+m+n%2-1,r=c+l+~~(n/2)-1;k+=(0>p||0>r||12<p||12<
r?1:b[r][p]==e?1:0)*Math.pow(2,3-n)}f.push(k)}for(a=0;4>a;a++)d.push(g[f[a]][3-a]);return d}(k,m);13==l[0]&&(16==l[1]&&(l[1]=14),31==l[2]&&(l[2]=19));18==l[1]&&(15==l[0]&&(l[0]=17),36==l[3]&&(l[3]=24));43==l[2]&&(25==l[0]&&(l[0]=37),46==l[3]&&(l[3]=44));48==l[3]&&(30==l[1]&&(l[1]=42),45==l[2]&&(l[2]=47));for(var n=0;4>n;n++)h(a,k*d+d/2*(n%2)+e,m*d+d/2*~~(n/2)+f,core.material.images.autotile[c.event.id],l[n],d)};
core.prototype.noPassExists=function(a,b,c){a=core.getBlock(a,b,c);return null==a?!1:core.isset(a.block.event.noPass)&&a.block.event.noPass};core.prototype.noPass=function(a,b){return 0>a||12<a||0>b||12<b||core.noPassExists(a,b)};core.prototype.npcExists=function(a,b,c){a=core.getBlock(a,b,c);return null==a?!1:"npcs"==a.block.event.cls};core.prototype.terrainExists=function(a,b,c,d){a=core.getBlock(a,b,d);return null==a?!1:"terrains"==a.block.event.cls&&(core.isset(c)?a.block.event.id==c:!0)};
core.prototype.stairExists=function(a,b,c){a=core.getBlock(a,b,c);return null==a?!1:"terrains"==a.block.event.cls&&("upFloor"==a.block.event.id||"downFloor"==a.block.event.id)};core.prototype.nearStair=function(){var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");return core.stairExists(a,b)||core.stairExists(a-1,b)||core.stairExists(a,b-1)||core.stairExists(a+1,b)||core.stairExists(a,b+1)};
core.prototype.enemyExists=function(a,b,c,d){a=core.getBlock(a,b,d);return null==a?!1:"enemys"==a.block.event.cls&&(core.isset(c)?a.block.event.id==c:!0)};core.prototype.getBlock=function(a,b,c,d){core.isset(c)||(c=core.status.floorId);core.isset(d)||(d=!0);c=core.status.maps[c].blocks;for(var e=0;e<c.length;e++)if(c[e].x==a&&c[e].y==b&&core.isset(c[e].event)){if(d&&core.isset(c[e].enable)&&!c[e].enable)break;return{index:e,block:c[e]}}return null};
core.prototype.moveBlock=function(a,b,c,d,e,f){d=d||500;core.status.replay.animate=!0;core.saveCanvas("animate");core.clearMap("animate",0,0,416,416);var g=core.getBlock(a,b,core.status.floorId,!1);if(null==g)core.isset(f)&&f();else{core.removeBlock(a,b);core.clearMap("ui",0,0,416,416);core.setAlpha("ui",1);g=g.block;blockIcon=core.material.icons[g.event.cls][g.event.id];blockImage=core.material.images[g.event.cls];var h=1;core.setOpacity("animate",h);core.canvas.animate.drawImage(blockImage,0,32*
blockIcon,32,32,32*g.x,32*g.y,32,32);var k=[];c.forEach(function(a){if("string"==typeof a)k.push(a);else if(core.isset(a.value))for(var b=0;b<a.value;b++)k.push(a.direction);else k.push(a.direction)});var m=32*a,l=32*b,n=0,p={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}},r=g.event.animate||1,t=0,q=0,u=window.setInterval(function(){q+=d/16/core.status.replay.speed;q>=2*core.values.animateSpeed/r&&(t++,q=0,t>=r&&(t=0));0==k.length?(h=e?0:h-.06,core.setOpacity("animate",h),core.clearMap("animate",
m,l,32,32),core.canvas.animate.drawImage(blockImage,32*t,32*blockIcon,32,32,m,l,32,32),0>=h&&(clearInterval(u),core.loadCanvas("animate"),core.clearMap("animate",0,0,416,416),core.setOpacity("animate",1),core.status.replay.animate=!1,core.isset(f)&&f())):(n++,m+=2*p[k[0]].x,l+=2*p[k[0]].y,core.clearMap("animate",m-32,l-32,96,96),core.canvas.animate.drawImage(blockImage,32*t,32*blockIcon,32,32,m,l,32,32),16==n&&(n=0,k.shift()))},d/16/core.status.replay.speed)}};
core.prototype.animateBlock=function(a,b,c,d){"hide"!=b&&(b="show");core.status.replay.animate=!0;core.saveCanvas("animate");core.clearMap("animate",0,0,416,416);"number"==typeof a[0]&&"number"==typeof a[1]&&(a=[a]);var e=[];a.forEach(function(a){var b=core.getBlock(a[0],a[1],core.status.floorId,!1);null!=b&&(b=b.block,e.push({x:a[0],y:a[1],blockIcon:core.material.icons[b.event.cls][b.event.id],blockImage:core.material.images[b.event.cls]}))});if(0==e.length)core.isset(d)&&d();else{var f=function(){e.forEach(function(a){core.canvas.animate.drawImage(a.blockImage,
0,32*a.blockIcon,32,32,32*a.x,32*a.y,32,32)})},g=0;"hide"==b&&(g=1);core.setOpacity("animate",g);f();var h=window.setInterval(function(){g="show"==b?g+.1:g-.1;core.setOpacity("animate",g);core.clearMap("animate",0,0,416,416);f();if(1<=g||0>=g)clearInterval(h),core.loadCanvas("animate"),core.clearMap("animate",0,0,416,416),core.setOpacity("animate",1),core.status.replay.animate=!1,core.isset(d)&&d()},c/10/core.status.replay.speed)}};
core.prototype.showBlock=function(a,b,c){c=c||core.status.floorId;a=core.getBlock(a,b,c,!1);null!=a&&(a=a.block,core.isset(a.enable)&&!a.enable&&(a.enable=!0,c==core.status.floorId&&core.isset(a.event)&&(blockIcon=core.material.icons[a.event.cls][a.event.id],blockImage=core.material.images[a.event.cls],core.canvas.event.drawImage(core.material.images[a.event.cls],0,32*blockIcon,32,32,32*a.x,32*a.y,32,32),core.addGlobalAnimate(a.event.animate,32*a.x,32*a.y,blockIcon,blockImage),core.syncGlobalAnimate()),
core.updateStatusBar()))};core.prototype.removeBlock=function(a,b,c){c=c||core.status.floorId;var d=core.getBlock(a,b,c,!1);null!=d&&(d=d.index,c==core.status.floorId&&(core.removeGlobalAnimate(a,b),core.canvas.event.clearRect(32*a,32*b,32,32)),core.removeBlockById(d,c),core.updateFg())};
core.prototype.removeBlockById=function(a,b){var c=core.status.maps[b].blocks,d=c[a].x,e=c[a].y,f=core.floors[b].events[d+","+e];core.isset(f)||(f=core.floors[b].changeFloor[d+","+e]);core.isset(f)?c[a].enable=!1:c.splice(a,1)};core.prototype.removeBlockByIds=function(a,b){b.sort(function(a,b){return b-a}).forEach(function(b){core.removeBlockById(b,a)})};
core.prototype.addGlobalAnimate=function(a,b,c,d,e){2==a?core.status.twoAnimateObjs.push({x:b,y:c,status:0,loc:d,image:e}):4==a&&core.status.fourAnimateObjs.push({x:b,y:c,status:0,loc:d,image:e})};
core.prototype.removeGlobalAnimate=function(a,b,c){1==c&&(core.status.twoAnimateObjs=[],core.status.fourAnimateObjs=[]);for(c=0;c<core.status.twoAnimateObjs.length;c++)if(core.status.twoAnimateObjs[c].x==32*a&&core.status.twoAnimateObjs[c].y==32*b){core.status.twoAnimateObjs.splice(c,1);return}for(c=0;c<core.status.fourAnimateObjs.length;c++)if(core.status.fourAnimateObjs[c].x==32*a&&core.status.fourAnimateObjs[c].y==32*b){core.status.fourAnimateObjs.splice(c,1);break}};
core.prototype.setGlobalAnimate=function(a){core.syncGlobalAnimate();core.animateFrame.speed=a;core.animateFrame.globalAnimate=!0};core.prototype.syncGlobalAnimate=function(){core.status.twoAnimateObjs.forEach(function(a){a.status=0});core.status.fourAnimateObjs.forEach(function(a){a.status=0})};
core.prototype.drawBoxAnimate=function(){for(var a=0;a<core.status.boxAnimateObjs.length;a++){var b=core.status.boxAnimateObjs[a];b.status=((b.status||0)+1)%2;core.clearMap("ui",b.bgx,b.bgy,b.bgsize,b.bgsize);core.fillRect("ui",b.bgx,b.bgy,b.bgsize,b.bgsize,core.animateFrame.background);core.canvas.ui.drawImage(b.image,32*b.status,32*b.icon,32,32,b.x,b.y,32,32)}};
core.prototype.drawAnimate=function(a,b,c,d){if(core.isset(core.status.replay)&&core.status.replay.replaying)core.isset(d)&&d();else if(core.isset(core.material.animates[a])&&core.isset(b)&&core.isset(c)){clearInterval(core.interval.animateInterval);core.clearMap("animate",0,0,416,416);var e=core.material.animates[a],f=e.ratio,g=32*b+16,h=32*c+16,k=0,m=function(a){core.clearMap("animate",0,0,416,416);e.frames[a].forEach(function(a){var b=e.images[a.index];if(core.isset(b)){var c=b.width*f*a.zoom/
100,d=b.height*f*a.zoom/100;core.setAlpha("animate",a.opacity/255);var k=g+a.x,m=h+a.y;a.mirror||a.angle?(core.saveCanvas("animate"),core.canvas.animate.translate(k,m),a.angle&&core.canvas.animate.rotate(-a.angle*Math.PI/180),a.mirror&&core.canvas.animate.scale(-1,1),core.canvas.animate.drawImage(b,-c/2,-d/2,c,d),core.loadCanvas("animate")):core.canvas.animate.drawImage(b,k-c/2,m-d/2,c,d)}})};m(k++);core.interval.animateInterval=setInterval(function(a){k==e.frames.length?(clearInterval(core.interval.animateInterval),
core.clearMap("animate",0,0,416,416),core.setAlpha("animate",1),core.isset(d)&&d()):m(k++)},50)}else core.isset(d)&&d()};
core.prototype.updateCheckBlock=function(){core.status.checkBlock={};if(core.isset(core.status.thisMap)){var a=core.status.thisMap.blocks;core.status.checkBlock.map=[];for(var b=0;b<a.length;b++){var c=a[b];if(core.isset(c.event)&&(!core.isset(c.enable)||c.enable)&&"enemys"==c.event.cls){var d=c.event.id,e=core.enemys.getEnemys(d);core.isset(e)&&(core.status.checkBlock.map[13*c.x+c.y]=d)}}core.status.checkBlock.damage=[];for(a=0;169>a;a++)core.status.checkBlock.damage[a]=0;for(a=0;13>a;a++)for(b=
0;13>b;b++)if(d=core.status.checkBlock.map[13*a+b],core.isset(d)){e=core.enemys.getEnemys(d);if(core.enemys.hasSpecial(e.special,15)){d=e.range||1;c=!1;core.isset(e.zoneSquare)&&(c=e.zoneSquare);for(var f=-d;f<=d;f++)for(var g=-d;g<=d;g++)if(0!=f||0!=g){var h=a+f,k=b+g;0>h||12<h||0>k||12<k||!c&&Math.abs(f)+Math.abs(g)>d||(core.status.checkBlock.damage[13*h+k]+=e.value)}}if(core.enemys.hasSpecial(e.special,18))for(f=-1;1>=f;f++)for(g=-1;1>=g;g++)if(0!=f||0!=g)h=a+f,k=b+g,0>h||12<h||0>k||12<k||1<Math.abs(f)+
Math.abs(g)||(core.status.checkBlock.damage[13*h+k]+=e.value)}core.status.checkBlock.betweenAttack=[];for(a=0;13>a;a++)for(b=0;13>b;b++)d=!1,0<a&&12>a&&(e=core.status.checkBlock.map[13*(a-1)+b],c=core.status.checkBlock.map[13*(a+1)+b],core.isset(e)&&core.isset(c)&&e==c&&(e=core.enemys.getEnemys(e),core.enemys.hasSpecial(e.special,16)&&(d=!0))),0<b&&12>b&&(e=core.status.checkBlock.map[13*a+b-1],c=core.status.checkBlock.map[13*a+b+1],core.isset(e)&&core.isset(c)&&e==c&&(e=core.enemys.getEnemys(e),core.enemys.hasSpecial(e.special,
16)&&(d=!0))),d&&(core.status.checkBlock.betweenAttack[13*a+b]=!0,e=core.status.hero.hp-core.status.checkBlock.damage[13*a+b],1<e&&(core.status.checkBlock.damage[13*a+b]+=parseInt((e+(core.flags.betweenAttackCeil?0:1))/2)))}};
core.prototype.checkBlock=function(){var a=core.getHeroLoc("x"),b=core.getHeroLoc("y"),c=core.status.checkBlock.damage[13*a+b];if(0<c){core.status.hero.hp-=c;var d=[],e={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}},f;for(f in e){var g=a+e[f].x,h=b+e[f].y;if(!(0>g||12<g||0>h||12<h)){var k=core.status.checkBlock.map[13*g+h];core.isset(k)&&(k=core.enemys.getEnemys(k),core.isset(k)&&core.enemys.hasSpecial(k.special,18)&&d.push({direction:f,x:g,y:h}))}}core.status.checkBlock.betweenAttack[13*
a+b]&&0<c?core.drawTip("\u53d7\u5230\u5939\u51fb\uff0c\u751f\u547d\u53d8\u6210\u4e00\u534a"):0<d.length&&0<c?core.drawTip("\u53d7\u5230\u963b\u51fb\u4f24\u5bb3"+c+"\u70b9"):0<c&&core.drawTip("\u53d7\u5230\u9886\u57df\u4f24\u5bb3"+c+"\u70b9");core.playSound("zone.ogg");core.drawAnimate("zone",a,b);0>=core.status.hero.hp?(core.status.hero.hp=0,core.updateStatusBar(),core.events.lose("zone")):(d=d.filter(function(a){var b=a.direction,c=a.x+e[b].x;a=a.y+e[b].y;return 0<=c&&12>=c&&0<=a&&12>=a&&null==core.getBlock(c,
a,core.status.floorId,!1)}),core.updateStatusBar(),0<d.length&&core.snipe(d))}};
core.prototype.snipe=function(a){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};a.forEach(function(a){var c=a.x,d=a.y;a.nx=c+b[a.direction].x;a.ny=d+b[a.direction].y;core.removeGlobalAnimate(c,d);c=core.getBlock(c,d).block;a.blockIcon=core.material.icons[c.event.cls][c.event.id];a.blockImage=core.material.images[c.event.cls];d=core.enemys.getDamage(c.event.id);var g=0>=d?"#00FF00":d<core.status.hero.hp/3?"#FFFFFF":d<2*core.status.hero.hp/3?"#FFFF00":d<core.status.hero.hp?"#FF7F00":
"#FF0000";999999999<=d?d="???":1E5<d&&(d=(d/1E4).toFixed(1)+"w");a.damage=d;a.color=g;a.block=core.clone(c)});var c=function(){a.forEach(function(a){core.removeBlock(a.x,a.y);var b=core.clone(a.block);b.x=a.nx;b.y=a.ny;core.status.thisMap.blocks.push(b);core.addGlobalAnimate(2,32*a.nx,32*a.ny,a.blockIcon,a.blockImage);core.canvas.event.drawImage(a.blockImage,0,32*a.blockIcon,32,32,32*a.nx,32*a.ny,32,32)});core.syncGlobalAnimate();core.updateStatusBar()};core.status.replay.replaying?c():core.waitHeroToStop(function(){core.lockControl();
var d=0,e=0,f=0;core.canvas.fg.textAlign="left";var g=window.setInterval(function(){d++;f+=31.25;f>=2*core.values.animateSpeed/2&&(e++,f=0,2<=e&&(e=0));a.forEach(function(a){var c=a.direction,f=32*a.x+2*b[c].x*d,g=32*a.y+2*b[c].y*d;core.clearMap("event",f-2*b[c].x,g-2*b[c].y,32,32);core.clearMap("fg",f-2*b[c].x,g-2*b[c].y,32,32);core.canvas.event.drawImage(a.blockImage,32*e,32*a.blockIcon,32,32,f,g,32,32);core.hasItem("book")&&(core.setFillStyle("fg","#000000"),core.canvas.fg.fillText(a.damage,f+
2,g+30),core.canvas.fg.fillText(a.damage,f,g+30),core.canvas.fg.fillText(a.damage,f+2,g+32),core.canvas.fg.fillText(a.damage,f,g+32),core.setFillStyle("fg",a.color),core.canvas.fg.fillText(a.damage,f+1,g+31))});16==d&&(clearInterval(g),c(),null==core.status.event.id&&core.unLockControl())},31.25)})};
core.prototype.setWeather=function(a,b){if("rain"!=a&&"snow"!=a)core.clearMap("weather",0,0,416,416),core.animateFrame.weather.type=null,core.animateFrame.weather.level=0,core.animateFrame.weather.nodes=[];else if(b=parseInt(b),a!=core.animateFrame.weather.type||core.isset(b)&&20*b!=core.animateFrame.weather.level)if(core.isset(b)||(b=5),1>b&&(b=1),10<b&&(b=10),b*=20,core.clearMap("weather",0,0,416,416),core.animateFrame.weather.type=a,core.animateFrame.weather.level=b,core.animateFrame.weather.nodes=
[],"rain"==a)for(a=0;a<b;a++)core.animateFrame.weather.nodes.push({x:416*Math.random(),y:416*Math.random(),l:2.5*Math.random(),xs:4*Math.random()+-2,ys:10*Math.random()+10});else if("snow"==a)for(a=0;a<b;a++)core.animateFrame.weather.nodes.push({x:416*Math.random(),y:416*Math.random(),r:5*Math.random()+1,d:Math.random()*b})};
core.prototype.setFg=function(a,b,c){core.isset(b)||(b=750);0>=b&&(b=0);core.isset(core.status.curtainColor)||(core.status.curtainColor=[0,0,0,0]);var d=core.status.curtainColor;core.isset(a)||(a=[0,0,0,0]);3==a.length&&a.push(1);0>a[3]&&(a[3]=0);1<a[3]&&(a[3]=1);if(0==b)core.dom.curtain.style.background=core.arrayToRGB(a),core.dom.curtain.style.opacity=a[3],core.status.curtainColor=a,core.isset(c)&&c();else{var e=0;core.status.replay.animate=!0;var f=setInterval(function(){e++;var b=d[3]+(a[3]-d[3])*
e/25,h=parseInt(d[0]+(a[0]-d[0])*e/25),k=parseInt(d[1]+(a[1]-d[1])*e/25),m=parseInt(d[2]+(a[2]-d[2])*e/25);core.dom.curtain.style.background=core.arrayToRGB([h,k,m]);core.dom.curtain.style.opacity=b;25<=e&&(clearInterval(f),core.status.curtainColor=a,core.status.replay.animate=!1,core.isset(c)&&c())},b/25)}};
core.prototype.updateFg=function(){if(core.isset(core.status.thisMap)&&core.isset(core.status.thisMap.blocks)){var a=core.status.thisMap.blocks;core.clearMap("fg",0,0,416,416);if(core.hasItem("book")){core.setFont("fg","bold 11px Arial");var b=core.status.hero.hp;if(core.flags.displayEnemyDamage){core.canvas.fg.textAlign="left";for(var c=0;c<a.length;c++){var d=a[c].x,e=a[c].y;if(core.isset(a[c].event)&&"enemys"==a[c].event.cls&&(!core.isset(a[c].enable)||a[c].enable)){if("battle"!=a[c].event.trigger){var f=
core.floors[core.status.floorId].events[d+","+e];if(core.isset(f)&&!(f instanceof Array)&&core.isset(f.displayDamage)&&!f.displayDamage)continue}f=core.enemys.getDamage(a[c].event.id);var g=0>=f?"#00FF00":f<b/3?"#FFFFFF":f<2*b/3?"#FFFF00":f<b?"#FF7F00":"#FF0000";999999999<=f?f="???":1E5<f&&(f=(f/1E4).toFixed(1)+"w");core.setFillStyle("fg","#000000");core.canvas.fg.fillText(f,32*d+2,32*(e+1)-2);core.canvas.fg.fillText(f,32*d,32*(e+1)-2);core.canvas.fg.fillText(f,32*d+2,32*(e+1));core.canvas.fg.fillText(f,
32*d,32*(e+1));core.setFillStyle("fg",g);core.canvas.fg.fillText(f,32*d+1,32*(e+1)-1)}}}if(core.flags.displayExtraDamage)for(core.canvas.fg.textAlign="center",d=0;13>d;d++)for(e=0;13>e;e++)f=core.status.checkBlock.damage[13*d+e],0<f&&(core.setFillStyle("fg","#000000"),core.canvas.fg.fillText(f,32*d+17,32*(e+1)-13),core.canvas.fg.fillText(f,32*d+15,32*(e+1)-15),core.canvas.fg.fillText(f,32*d+17,32*(e+1)-15),core.canvas.fg.fillText(f,32*d+15,32*(e+1)-13),core.setFillStyle("fg","#FF7F00"),core.canvas.fg.fillText(f,
32*d+16,32*(e+1)-14))}}};core.prototype.itemCount=function(a){if(!core.isset(a)||!core.isset(core.material.items[a]))return 0;var b=core.material.items[a].cls;return"items"==b?0:core.isset(core.status.hero.items[b][a])?core.status.hero.items[b][a]:0};core.prototype.hasItem=function(a){return 0<core.itemCount(a)};
core.prototype.setItem=function(a,b){var c=core.material.items[a].cls;"items"!=c&&(core.isset(core.status.hero.items[c])||(core.status.hero.items[c]={}),core.status.hero.items[c][a]=b,"keys"!=c&&0==b&&delete core.status.hero.items[c][a])};core.prototype.removeItem=function(a){if(!core.hasItem(a))return!1;var b=core.material.items[a].cls;core.status.hero.items[b][a]--;"keys"!=b&&0==core.status.hero.items[b][a]&&delete core.status.hero.items[b][a];core.updateStatusBar();return!0};
core.prototype.useItem=function(a,b){core.items.useItem(a,b)};core.prototype.canUseItem=function(a){return core.items.canUseItem(a)};core.prototype.addItem=function(a,b){var c=core.material.items[a].cls;"items"!=c&&(core.isset(core.status.hero.items[c])?core.isset(core.status.hero.items[c][a])||(core.status.hero.items[c][a]=0):(core.status.hero.items[c]={},core.status.hero.items[c][a]=0),core.status.hero.items[c][a]+=b)};
core.prototype.getNextItem=function(){if(core.status.heroStop&&core.flags.enableGentleClick){var a=core.nextX(),b=core.nextY(),c=core.getBlock(a,b);null!=c&&"getItem"==c.block.event.trigger&&(core.getItem(c.block.event.id,1,a,b),core.status.route.push("getNext"))}};
core.prototype.getItem=function(a,b,c,d,e){core.playSound("item.ogg");var f=core.material.items[a].cls;core.items.getItemEffect(a,b);core.removeBlock(c,d);var g="\u83b7\u5f97 "+core.material.items[a].name;1<b&&(g+="x"+b);"items"===f&&(g+=core.items.getItemEffectTip(a));core.drawTip(g,core.material.icons.items[a]);core.canvas.event.clearRect(32*c,32*d,32,32);core.updateStatusBar();a=core.floors[core.status.floorId].afterGetItem[c+","+d];core.isset(a)?core.events.doEvents(a,c,d,e):core.isset(e)&&e()};
core.prototype.drawTip=function(a,b){var c=!1,d=0;clearInterval(core.interval.tipAnimate);core.setFont("data","16px Arial");core.saveCanvas("data");core.setOpacity("data",0);core.canvas.data.textAlign="left";if(core.isset(b)){var e=44;var f=18;var g=e+core.canvas.data.measureText(a).width+8}else e=16,f=18,g=e+core.canvas.data.measureText(a).width+16;core.interval.tipAnimate=window.setInterval(function(){d=c?d-.1:d+.1;core.setOpacity("data",d);core.clearMap("data",5,5,400,42);core.fillRect("data",
5,5,g,42,"#000");core.isset(b)&&core.canvas.data.drawImage(core.material.images.items,0,32*b,32,32,10,8,32,32);core.fillText("data",a,e+5,f+15,"#fff");if(.6<d||0>d)c?(core.loadCanvas("data"),core.clearMap("data",5,5,400,42),core.setOpacity("data",1),clearInterval(core.interval.tipAnimate)):(core.isset(core.timeout.getItemTipTimeout)||(core.timeout.getItemTipTimeout=window.setTimeout(function(){c=!0;core.timeout.getItemTipTimeout=null},750)),d=.6,core.setOpacity("data",d))},30)};
core.prototype.drawText=function(a,b){if(core.isset(a))if(core.isset(core.status.event)&&"action"==core.status.event.id)core.insertAction(a,null,null,b);else{if("string"==typeof a)a=[{content:a}];else if(a instanceof Object&&core.isset(a.content))a=[a];else if(!(a instanceof Array)){core.drawTip("\u51fa\u9519\u4e86");return}core.status.event={id:"text",data:{list:a,callback:b}};core.lockControl();core.stopAutomaticRoute();setTimeout(function(){core.drawText()},30)}else 0==core.status.event.data.list.length?
(b=core.status.event.data.callback,core.ui.closePanel(!1),core.isset(b)&&b()):(a=core.status.event.data.list.shift(),"string"==typeof a?core.ui.drawTextBox(a):core.ui.drawTextBox(a.content,a.id))};core.prototype.replaceText=function(a){return a.replace(/\${([^}]+)}/g,function(a,c){return core.calValue(c)})};
core.prototype.calValue=function(a){a=a.replace(/status:([\w\d_]+)/g,"core.getStatus('$1')");a=a.replace(/item:([\w\d_]+)/g,"core.itemCount('$1')");a=a.replace(/flag:([\w\d_]+)/g,"core.getFlag('$1', false)");return eval(a)};core.prototype.doEffect=function(a){a=a.split("+=");if(2==a.length){var b=a[0];a=core.calValue(a[1]);0==b.indexOf("status:")?(b=b.substring(7),core.setStatus(b,core.getStatus(b)+a)):0==b.indexOf("item:")&&(b=b.substring(5),core.setItem(b,core.itemCount(b)+a))}};
core.prototype.splitLines=function(a,b,c,d){core.isset(d)&&core.setFont(a,d);d=[];for(var e=0,f=0;f<b.length;f++)if("\n"==b.charAt(f))d.push(b.substring(e,f)),e=f+1;else if("\\"==b.charAt(f)&&"n"==b.charAt(f+1))d.push(b.substring(e,f)),e=f+2;else{var g=b.substring(e,f+1);core.canvas[a].measureText(g).width>c&&(d.push(b.substring(e,f)),e=f)}d.push(b.substring(e));return d};
core.prototype.unshift=function(a,b){if(a instanceof Array&&core.isset(b))return b instanceof Array?core.clone(b).reverse().forEach(function(b){a.unshift(b)}):a.unshift(b),a};core.prototype.setLocalStorage=function(a,b){try{return localStorage.setItem(core.firstData.name+"_"+a,JSON.stringify(b)),!0}catch(c){return!1}};core.prototype.getLocalStorage=function(a,b){a=localStorage.getItem(core.firstData.name+"_"+a);return core.isset(a)?JSON.parse(a):b};
core.prototype.removeLocalStorage=function(a){localStorage.removeItem(core.firstData.name+"_"+a)};core.prototype.clone=function(a){if(!core.isset(a))return a;if(a instanceof Date){var b=new Date;b.setTime(a.getTime());return b}if(a instanceof Array){b=[];for(var c in a)b[c]=core.clone(a[c]);return b}if(a instanceof Function)return a;if(a instanceof Object){b={};for(c in a)a.hasOwnProperty(c)&&(b[c]=core.clone(a[c]));return b}return a};
core.prototype.formatDate=function(a){return core.isset(a)?a.getFullYear()+"-"+core.setTwoDigits(a.getMonth()+1)+"-"+core.setTwoDigits(a.getDate())+" "+core.setTwoDigits(a.getHours())+":"+core.setTwoDigits(a.getMinutes())+":"+core.setTwoDigits(a.getSeconds()):""};
core.prototype.formatDate2=function(a){return core.isset(a)?a.getFullYear()+core.setTwoDigits(a.getMonth()+1)+core.setTwoDigits(a.getDate())+core.setTwoDigits(a.getHours())+core.setTwoDigits(a.getMinutes())+core.setTwoDigits(a.getSeconds()):""};core.prototype.setTwoDigits=function(a){return 10>parseInt(a)?"0"+a:a};
core.prototype.arrayToRGB=function(a){var b=parseInt(a[0])||0,c=parseInt(a[1])||0;a=parseInt(a[2])||0;0>b&&(b=0);0>a&&(a=0);0>c&&(c=0);255<b&&(b=255);255<a&&(a=255);255<c&&(c=255);return"#"+(16777216+(b<<16)+(c<<8)+a).toString(16).slice(1)};
core.prototype.debug=function(){core.setStatus("hp",999999);core.setStatus("atk",1E4);core.setStatus("def",1E4);core.setStatus("mdef",1E4);core.setStatus("money",1E4);core.setStatus("experience",1E4);core.setItem("yellowKey",50);core.setItem("blueKey",50);core.setItem("redKey",50);core.setItem("book",1);core.setItem("fly",1);for(var a in core.status.maps)core.status.maps[a].canFlyTo&&0>core.status.hero.flyRange.indexOf(a)&&core.status.hero.flyRange.push(a);core.updateStatusBar();core.drawTip("\u4f5c\u5f0a\u6210\u529f")};
core.prototype.startReplay=function(a){core.status.replay.replaying=!0;core.status.replay.pausing=!1;core.status.replay.speed=1;core.status.replay.toReplay=core.clone(a);core.status.replay.totalList=core.clone(a);core.updateStatusBar();core.drawTip("\u5f00\u59cb\u64ad\u653e");this.replay()};core.prototype.triggerReplay=function(){core.status.replay.pausing?this.resumeReplay():this.pauseReplay()};
core.prototype.pauseReplay=function(){core.status.replay.replaying&&(core.status.replay.pausing=!0,core.updateStatusBar(),core.drawTip("\u6682\u505c\u64ad\u653e"))};core.prototype.resumeReplay=function(){core.status.replay.replaying&&(core.status.replay.pausing=!1,core.updateStatusBar(),core.drawTip("\u6062\u590d\u64ad\u653e"),core.replay())};
core.prototype.forwardReplay=function(){core.status.replay.replaying&&(core.status.replay.speed=parseInt(10*core.status.replay.speed+1)/10,2.5<core.status.replay.speed&&(core.status.replay.speed=2.5),core.drawTip("x"+core.status.replay.speed+"\u500d"))};core.prototype.rewindReplay=function(){core.status.replay.replaying&&(core.status.replay.speed=parseInt(10*core.status.replay.speed-1)/10,.3>core.status.replay.speed&&(core.status.replay.speed=.3),core.drawTip("x"+core.status.replay.speed+"\u500d"))};
core.prototype.stopReplay=function(){core.status.replay.replaying&&(core.status.replay.toReplay=[],core.status.replay.totalList=[],core.status.replay.replaying=!1,core.status.replay.pausing=!1,core.status.replay.speed=1,core.updateStatusBar(),core.drawTip("\u505c\u6b62\u64ad\u653e\u5e76\u6062\u590d\u6e38\u620f"))};
core.prototype.replay=function(){if(core.status.replay.replaying&&!core.status.replay.pausing&&!core.status.replay.animate)if(0==core.status.replay.toReplay.length)core.stopReplay(),core.insertAction("\u5f55\u50cf\u56de\u653e\u5b8c\u6bd5\uff01");else{var a=core.status.replay.toReplay.shift();if("up"==a||"down"==a||"left"==a||"right"==a)core.moveHero(a,function(){core.replay()});else{if(0==a.indexOf("item:")){var b=a.substring(5);if(core.canUseItem(b)){var c=Object.keys(core.status.hero.items.tools).sort();
a=Object.keys(core.status.hero.items.constants).sort();if(0<=(c=c.indexOf(b))||100<=(c=a.indexOf(b)+100))core.ui.drawToolbox(c),setTimeout(function(){core.ui.closePanel();core.useItem(b,function(){core.replay()})},750);return}}else if(0==a.indexOf("fly:")){var d=a.substring(4),e=core.status.hero.flyRange.indexOf(d),f=core.status.hero.flyRange.indexOf(core.status.floorId);if(core.hasItem("fly")&&0<=e&&0<=f){core.ui.drawFly(e);setTimeout(function(){core.ui.closePanel();var a=e<f?"upFloor":"downFloor";
core.status.route.push("fly:"+d);core.changeFloor(d,a,null,null,function(){core.replay()})},750);return}}else if(0==a.indexOf("shop:")){a=a.substring(5).split(":");var g=a[0],h=a[1].split("");if(0<h.length&&(a=core.status.shops[g],core.isset(a)&&a.visited)){var k=a.choices,m=6-parseInt(k.length/2);core.status.event.selection=parseInt(h.shift());core.events.openShop(g,!1);var l=setInterval(function(){core.events.clickShop(6,m+core.status.event.selection)?0==h.length?(clearInterval(l),core.events.clickShop(6,
m+k.length),core.replay()):(core.status.event.selection=parseInt(h.shift()),core.events.openShop(g,!1)):(clearInterval(l),core.stopReplay(),core.drawTip("\u5f55\u50cf\u6587\u4ef6\u51fa\u9519"))},750);return}}else{if("turn"==a){core.turnHero();core.replay();return}if("getNext"==a){if(core.flags.enableGentleClick&&null!=core.getBlock(core.nextX(),core.nextY())){a=core.nextX();c=core.nextY();var n=core.getBlock(a,c);if(null!=n&&"getItem"==n.block.event.trigger){core.getItem(n.block.event.id,1,a,c);core.status.route.push("getNext");
core.replay();return}}}else if(0==a.indexOf("move:")&&(c=a.substring(5).split(":"),a=parseInt(c[0]),c=parseInt(c[1]),core.canMoveDirectly(a,c))){core.clearMap("hero",0,0,416,416);core.setHeroLoc("x",a);core.setHeroLoc("y",c);core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");core.status.route.push("move:"+a+":"+c);core.replay();return}}core.stopReplay();core.insertAction("\u5f55\u50cf\u6587\u4ef6\u51fa\u9519")}}};
core.prototype.checkStatus=function(a,b,c){if(b&&core.status.event.id==a)return core.ui.closePanel(),!1;if(b&&core.status.lockControl)return!1;if(core.isset(c)&&c&&!core.hasItem(a))return core.drawTip("\u4f60\u6ca1\u6709"+core.material.items[a].name),!1;if(!core.status.heroStop)return core.drawTip("\u8bf7\u5148\u505c\u6b62\u52c7\u58eb\u884c\u52a8"),!1;core.lockControl();core.status.event.id=a;return!0};
core.prototype.openBook=function(a){core.isset(core.status.replay)&&core.status.replay.replaying||("book"==core.status.event.id&&core.isset(core.status.event.selection)?(core.status.boxAnimateObjs=[],core.ui.drawMaps(core.status.event.selection)):("viewMaps"==core.status.event.id&&(a=!1,core.status.event.selection=core.status.event.data),core.checkStatus("book",a,!0)&&core.useItem("book")))};
core.prototype.useFly=function(a){core.isset(core.status.replay)&&core.status.replay.replaying||!core.checkStatus("fly",a,!0)||(core.flags.flyNearStair&&!core.nearStair()?(core.drawTip("\u53ea\u6709\u5728\u697c\u68af\u8fb9\u624d\u80fd\u4f7f\u7528\u4f20\u9001\u5668"),core.unLockControl(),core.status.event.data=null,core.status.event.id=null):core.canUseItem("fly")?core.useItem("fly"):(core.drawTip("\u697c\u5c42\u4f20\u9001\u5668\u597d\u50cf\u5931\u6548\u4e86"),core.unLockControl(),core.status.event.data=
null,core.status.event.id=null))};core.prototype.openToolbox=function(a){core.isset(core.status.replay)&&core.status.replay.replaying||core.checkStatus("toolbox",a)&&core.ui.drawToolbox()};core.prototype.openQuickShop=function(a){core.isset(core.status.replay)&&core.status.replay.replaying||core.checkStatus("selectShop",a)&&core.ui.drawQuickShop()};
core.prototype.save=function(a){if((!core.isset(core.status.replay)||!core.status.replay.replaying)&&core.checkStatus("save",a)){a=core.status.saveIndex;var b=parseInt((a-1)/5);core.ui.drawSLPanel(10*b+(a-5*b))}};
core.prototype.load=function(a){if(!core.isset(core.status.replay)||!core.status.replay.replaying){var b=core.getLocalStorage("saveIndex2",1),c=parseInt((b-1)/5);b-=5*c;core.isPlaying()?core.checkStatus("load",a)&&core.ui.drawSLPanel(10*c+b):(core.status.event={id:"load",data:null},core.status.lockControl=!0,core.dom.startPanel.style.display="none",core.ui.drawSLPanel(10*c+b))}};
core.prototype.openSettings=function(a){core.isset(core.status.replay)&&core.status.replay.replaying||core.checkStatus("settings",a)&&core.ui.drawSettings()};core.prototype.autosave=function(a){var b=null;a&&(b=core.status.route.pop());core.saveData("autoSave");a&&core.isset(b)&&core.status.route.push(b)};
core.prototype.doSL=function(a,b){if("save"==b)"autoSave"==a?core.drawTip("\u4e0d\u80fd\u8986\u76d6\u81ea\u52a8\u5b58\u6863\uff01"):core.saveData("save"+a)?(core.ui.closePanel(),core.drawTip("\u5b58\u6863\u6210\u529f\uff01"),"autoSave"!=a&&(core.status.saveIndex=a,core.setLocalStorage("saveIndex2",core.status.saveIndex))):core.drawTip("\u5b58\u50a8\u7a7a\u95f4\u4e0d\u8db3\uff0c\u8bf7\u8986\u76d6\u5df2\u6709\u7684\u5b58\u6863\u6216\u5728\u83dc\u5355\u680f\u4e2d\u8fdb\u884c\u6e05\u7406");else if("load"==
b){var c=core.getLocalStorage("autoSave"==a?a:"save"+a,null);core.isset(c)?c.version!=core.firstData.version?confirm("\u5b58\u6863\u7248\u672c\u4e0d\u5339\u914d\uff01\n\u4f60\u60f3\u56de\u653e\u6b64\u5b58\u6863\u7684\u5f55\u50cf\u5417\uff1f")&&(core.dom.startPanel.style.display="none",core.resetStatus(core.firstData.hero,c.hard,core.firstData.floorId,null,core.initStatus.maps),core.events.setInitData(c.hard),core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){core.startReplay(core.decodeRoute(c.route))})):
(core.ui.closePanel(),core.loadData(c,function(){core.drawTip("\u8bfb\u6863\u6210\u529f");"autoSave"!=a&&(core.status.saveIndex=a,core.setLocalStorage("saveIndex2",core.status.saveIndex))})):core.drawTip("\u65e0\u6548\u7684\u5b58\u6863")}};
core.prototype.syncSave=function(a){var b=null;if("all"==a)for(b=[],a=1;150>=a;a++){var c=core.getLocalStorage("save"+a,null);core.isset(c)&&b.push(c)}else for(a=150;1<=a&&(b=core.getLocalStorage("save"+a,null),!core.isset(b));a--);if(core.isset(b)){core.ui.drawWaiting("\u6b63\u5728\u540c\u6b65\uff0c\u8bf7\u7a0d\u540e...");a=new FormData;a.append("type","save");a.append("name",core.firstData.name);b=JSON.stringify(b);a.append("data",b);var d=new XMLHttpRequest;d.open("POST","/games/sync.php");d.onload=
function(a){200==d.status?(a=JSON.parse(d.response),0>a.code?core.drawText("\u51fa\u9519\u5566\uff01\n\u65e0\u6cd5\u540c\u6b65\u5b58\u6863\u5230\u670d\u52a1\u5668\u3002\n\u9519\u8bef\u539f\u56e0\uff1a"+a.msg):core.drawText("\u540c\u6b65\u6210\u529f\uff01\n\n\u60a8\u7684\u5b58\u6863\u7f16\u53f7\uff1a "+a.code+"\n\u60a8\u7684\u5b58\u6863\u5bc6\u7801\uff1a "+a.msg+"\n\n\u8bf7\u7262\u8bb0\u4ee5\u4e0a\u4e24\u4e2a\u4fe1\u606f\uff08\u5982\u622a\u56fe\u7b49\uff09\uff0c\u5728\u4ece\u670d\u52a1\u5668\n\u540c\u6b65\u5b58\u6863\u65f6\u4f7f\u7528\u3002")):
core.drawText("\u51fa\u9519\u5566\uff01\n\u65e0\u6cd5\u540c\u6b65\u5b58\u6863\u5230\u670d\u52a1\u5668\u3002\n\u9519\u8bef\u539f\u56e0\uff1aHTTP "+d.status)};d.ontimeout=function(){core.drawText("\u51fa\u9519\u5566\uff01\n\u65e0\u6cd5\u540c\u6b65\u5b58\u6863\u5230\u670d\u52a1\u5668\u3002\n\u9519\u8bef\u539f\u56e0\uff1aTimeout")};d.onerror=function(){core.drawText("\u51fa\u9519\u5566\uff01\n\u65e0\u6cd5\u540c\u6b65\u5b58\u6863\u5230\u670d\u52a1\u5668\u3002\n\u9519\u8bef\u539f\u56e0\uff1aXHR Error")};
d.send(a)}else core.drawText("\u6ca1\u6709\u8981\u540c\u6b65\u7684\u5b58\u6863")};
core.prototype.syncLoad=function(){var a=prompt("\u8bf7\u8f93\u5165\u5b58\u6863\u7f16\u53f7\uff1a");if(null==a||""==a)core.ui.drawSyncSave();else{var b=prompt("\u8bf7\u8f93\u5165\u5b58\u6863\u5bc6\u7801\uff1a");if(null==b||""==b)core.ui.drawSyncSave();else{core.ui.drawWaiting("\u6b63\u5728\u540c\u6b65\uff0c\u8bf7\u7a0d\u540e...");var c=new FormData;c.append("type","load");c.append("name",core.firstData.name);c.append("id",a);c.append("password",b);var d=new XMLHttpRequest;d.open("POST","/games/sync.php");
d.onload=function(b){if(200==d.status)switch(b=JSON.parse(d.response),b.code){case 0:var c=JSON.parse(b.msg);if(c instanceof Array)core.status.event.selection=1,core.ui.drawConfirmBox("\u6240\u6709\u672c\u5730\u5b58\u6863\u90fd\u5c06\u88ab\u8986\u76d6\uff0c\u786e\u8ba4\uff1f",function(){for(var a=1;150>=a;a++)a<=c.length?core.setLocalStorage("save"+a,c[a-1]):core.removeLocalStorage("save"+a);core.drawText("\u540c\u6b65\u6210\u529f\uff01\n\u4f60\u7684\u672c\u5730\u6240\u6709\u5b58\u6863\u5747\u5df2\u88ab\u8986\u76d6\u3002")},
function(){core.status.event.selection=0;core.ui.drawSyncSave()});else{for(var e=b=150;1<=e;e--)if(null==core.getLocalStorage("save"+e,null))b=e;else break;core.setLocalStorage("save"+b,c);core.drawText("\u540c\u6b65\u6210\u529f\uff01\n\u5355\u5b58\u6863\u5df2\u8986\u76d6\u81f3\u5b58\u6863"+b)}break;case -1:core.drawText("\u51fa\u9519\u5566\uff01\n\u5b58\u6863\u7f16\u53f7"+a+"\u4e0d\u5b58\u5728\uff01");break;case -2:core.drawText("\u51fa\u9519\u5566\uff01\n\u5b58\u6863\u5bc6\u7801\u9519\u8bef\uff01");
break;default:core.drawText("\u51fa\u9519\u5566\uff01\n\u65e0\u6cd5\u4ece\u670d\u52a1\u5668\u540c\u6b65\u5b58\u6863\u3002\n\u9519\u8bef\u539f\u56e0\uff1a"+b.msg)}else core.drawText("\u51fa\u9519\u5566\uff01\n\u65e0\u6cd5\u4ece\u670d\u52a1\u5668\u540c\u6b65\u5b58\u6863\u3002\n\u9519\u8bef\u539f\u56e0\uff1aHTTP "+d.status)};d.ontimeout=function(){core.drawText("\u51fa\u9519\u5566\uff01\n\u65e0\u6cd5\u4ece\u670d\u52a1\u5668\u540c\u6b65\u5b58\u6863\u3002\n\u9519\u8bef\u539f\u56e0\uff1aTimeout")};d.onerror=
function(){core.drawText("\u51fa\u9519\u5566\uff01\n\u65e0\u6cd5\u4ece\u670d\u52a1\u5668\u540c\u6b65\u5b58\u6863\u3002\n\u9519\u8bef\u539f\u56e0\uff1aXHR Error")};d.send(c)}}};
core.prototype.saveData=function(a){var b={floorId:core.status.floorId,hero:core.clone(core.status.hero),hard:core.status.hard,maps:core.maps.save(core.status.maps),route:core.encodeRoute(core.status.route),shops:{},version:core.firstData.version,time:(new Date).getTime()},c;for(c in core.status.shops)b.shops[c]={times:core.status.shops[c].times||0,visited:core.status.shops[c].visited||!1};core.events.beforeSaveData(b);return core.setLocalStorage(a,b)};
core.prototype.loadData=function(a,b){core.resetStatus(a.hero,a.hard,a.floorId,core.decodeRoute(a.route),core.maps.load(a.maps));for(var c in core.status.shops)core.isset(a.shops[c])&&(core.status.shops[c].times=a.shops[c].times,core.status.shops[c].visited=a.shops[c].visited);core.events.afterLoadData(a);core.changeFloor(a.floorId,null,a.hero.loc,0,function(){core.isset(b)&&b()})};
core.prototype.encodeRoute=function(a){var b="",c="",d=0,e=Object.keys(core.material.items).sort(),f=Object.keys(core.initStatus.shops).sort();a.forEach(function(a){"up"==a||"down"==a||"left"==a||"right"==a?(a!=c&&0<d&&(b+=c.substring(0,1).toUpperCase(),1<d&&(b+=d),d=0),c=a,d++):(0<d&&(b+=c.substring(0,1).toUpperCase(),1<d&&(b+=d),d=0),0==a.indexOf("item:")?b+="I"+e.indexOf(a.substring(5)):0==a.indexOf("fly:")?b+="F"+core.floorIds.indexOf(a.substring(4)):0==a.indexOf("choices:")?b+="C"+a.substring(8):
0==a.indexOf("shop:")?(a=a.substring(5).split(":"),b+="S"+f.indexOf(a[0])+":"+a[1]):"turn"==a?b+="T":"getNext"==a?b+="G":0==a.indexOf("input:")?b+="P"+a.substring(6):"no"==a?b+="N":0==a.indexOf("move:")&&(b+="M"+a.substring(5)))});0<d&&(b+=c.substring(0,1).toUpperCase(),1<d&&(b+=d));return b};
core.prototype.decodeRoute=function(a){if(!core.isset(a))return a;for(var b=[],c=0,d=function(b){for(var d="";c<a.length&&!isNaN(a.charAt(c));)d+=a.charAt(c++);0==d.length&&(d="1");return core.isset(b)?d:parseInt(d)},e=Object.keys(core.material.items).sort(),f=Object.keys(core.initStatus.shops).sort();c<a.length;){var g=a.charAt(c++),h=d();switch(g){case "U":for(g=0;g<h;g++)b.push("up");break;case "D":for(g=0;g<h;g++)b.push("down");break;case "L":for(g=0;g<h;g++)b.push("left");break;case "R":for(g=
0;g<h;g++)b.push("right");break;case "I":b.push("item:"+e[h]);break;case "F":b.push("fly:"+core.floorIds[h]);break;case "C":b.push("choices:"+h);break;case "S":++c;b.push("shop:"+f[h]+":"+d(!0));break;case "T":b.push("turn");break;case "G":b.push("getNext");break;case "P":b.push("input:"+h);break;case "N":b.push("no");break;case "M":++c,b.push("move:"+h+":"+d())}}return b};core.prototype.setStatus=function(a,b){core.status.hero[a]=b};core.prototype.getStatus=function(a){return core.status.hero[a]};
core.prototype.getLvName=function(){return core.status.hero.lv>core.firstData.levelUp.length?core.status.hero.lv:core.firstData.levelUp[core.status.hero.lv-1].name||core.status.hero.lv};core.prototype.setFlag=function(a,b){core.isset(core.status.hero)&&(core.status.hero.flags[a]=b)};core.prototype.getFlag=function(a,b){if(!core.isset(core.status.hero))return b;a=core.status.hero.flags[a];return core.isset(a)?a:b};core.prototype.hasFlag=function(a){return core.getFlag(a)?!0:!1};
core.prototype.insertAction=function(a,b,c,d){core.events.insertAction(a,b,c,d)};core.prototype.lockControl=function(){core.status.lockControl=!0};core.prototype.unLockControl=function(){core.status.lockControl=!1};core.prototype.isset=function(a){return void 0==a||null==a||"number"==typeof a&&isNaN(a)?!1:!0};
core.prototype.readFile=function(a,b){core.platform.isOnline?null==core.platform.fileReader?(alert("\u5f53\u524d\u6d4f\u89c8\u5668\u4e0d\u652f\u6301FileReader\uff01"),core.isset(b)&&b()):(null==core.platform.fileInput&&(core.platform.fileInput=document.createElement("input"),core.platform.fileInput.style.display="none",core.platform.fileInput.type="file",core.platform.fileInput.onchange=function(){0==core.platform.fileInput.files.length?core.isset(core.platform.errorCallback)&&core.platform.errorCallback():
(core.platform.fileReader.readAsText(core.platform.fileInput.files[0]),core.platform.fileInput.value="")}),core.platform.successCallback=a,core.platform.errorCallback=b,core.platform.fileInput.click()):(alert("\u79bb\u7ebf\u72b6\u6001\u4e0b\u4e0d\u652f\u6301\u6587\u4ef6\u8bfb\u53d6\uff01"),core.isset(b)&&b())};
core.prototype.download=function(a,b){if(core.platform.isOnline)if(core.platform.isIOS)alert("iOS\u5e73\u53f0\u4e0b\u4e0d\u652f\u6301\u4e0b\u8f7d\u64cd\u4f5c\uff01");else if(core.platform.isPC||core.platform.isChrome&&!core.platform.isQQ&&!core.platform.isWeChat)if(core.platform.isSafari)alert("\u4f60\u5f53\u524d\u4f7f\u7528\u7684\u662fSafari\u6d4f\u89c8\u5668\uff0c\u4e0d\u652f\u6301\u76f4\u63a5\u4e0b\u8f7d\u6587\u4ef6\u3002\n\u5373\u5c06\u6253\u5f00\u4e00\u4e2a\u65b0\u7a97\u53e3\u4e3a\u5e94\u4e0b\u8f7d\u5185\u5bb9\uff0c\u8bf7\u81ea\u884c\u5168\u9009\u590d\u5236\u7136\u540e\u521b\u5efa\u7a7a\u767d\u6587\u4ef6\u5e76\u7c98\u8d34\u3002"),
b=new Blob([b],{type:"text/plain;charset=utf-8"}),b=window.URL.createObjectURL(b),window.open(b,"_blank"),window.URL.revokeObjectURL(b);else if(b=new Blob([b],{type:"text/plain;charset=utf-8"}),window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(b,a);else{b=window.URL.createObjectURL(b);var c=window.document.createElement("a");c.href=b;c.download=a;document.body.appendChild(c);c.click();document.body.removeChild(c);window.URL.revokeObjectURL(b)}else core.copy(b)?alert("\u79fb\u52a8\u7aef\u53ea\u6709Chrome\u6d4f\u89c8\u5668\u652f\u6301\u76f4\u63a5\u4e0b\u8f7d\u6587\u4ef6\uff01\n\u6240\u6709\u5e94\u4e0b\u8f7d\u5185\u5bb9\u5df2\u7ecf\u590d\u5236\u5230\u60a8\u7684\u526a\u5207\u677f\uff0c\u8bf7\u81ea\u884c\u521b\u5efa\u7a7a\u767d\u6587\u4ef6\u5e76\u7c98\u8d34\u3002"):
alert("\u8be5\u5e73\u53f0\u6216\u6d4f\u89c8\u5668\u6682\u4e0d\u652f\u6301\u4e0b\u8f7d\u64cd\u4f5c\uff01");else alert("\u79bb\u7ebf\u72b6\u6001\u4e0b\u4e0d\u652f\u6301\u4e0b\u8f7d\u64cd\u4f5c\uff01")};
core.prototype.copy=function(a){if(!core.platform.supportCopy)return!1;var b=document.createElement("textarea");b.style.position="fixed";b.style.top=0;b.style.left=0;b.style.width="2em";b.style.height="2em";b.style.padding=0;b.style.border="none";b.style.outline="none";b.style.boxShadow="none";b.style.background="transparent";b.value=a;document.body.appendChild(b);b.select();a=!1;try{a=document.execCommand("copy")}catch(c){a=!1}document.body.removeChild(b);return a};
core.prototype.playBgm=function(a){if(core.musicStatus.bgmStatus&&core.isset(core.material.bgms[a]))if("loading"==core.material.bgms[a])core.material.bgms[a]="starting";else try{core.musicStatus.playingBgm==a&&core.musicStatus.isPlaying||(core.isset(core.musicStatus.playingBgm)&&core.musicStatus.isPlaying&&core.material.bgms[core.musicStatus.playingBgm].pause(),core.musicStatus.playingBgm=a,core.material.bgms[a].play(),core.musicStatus.isPlaying=!0)}catch(b){console.log("\u65e0\u6cd5\u64ad\u653eBGM "+
a),core.musicStatus.playingBgm=null}};core.prototype.pauseBgm=function(){try{core.isset(core.musicStatus.playingBgm)&&core.material.bgms[core.musicStatus.playingBgm].pause(),core.musicStatus.isPlaying=!1}catch(a){console.log("\u65e0\u6cd5\u6682\u505cBGM "+bgm)}};
core.prototype.resumeBgm=function(){if(core.musicStatus.bgmStatus)try{core.isset(core.musicStatus.playingBgm)?(core.material.bgms[core.musicStatus.playingBgm].play(),core.musicStatus.isPlaying=!0):0<core.bgms.length&&(core.playBgm(core.bgms[0]),core.musicStatus.isPlaying=!0)}catch(a){console.log("\u65e0\u6cd5\u6062\u590dBGM "+bgm)}};
core.prototype.playSound=function(a){if(core.musicStatus.soundStatus&&core.isset(core.material.sounds[a]))try{if(null!=core.musicStatus.audioContext){var b=core.musicStatus.audioContext.createBufferSource();b.buffer=core.material.sounds[a];b.connect(core.musicStatus.audioContext.destination);try{b.start(0)}catch(c){try{b.noteOn(0)}catch(d){}}}else core.material.sounds[a].play()}catch(c){console.log("\u65e0\u6cd5\u64ad\u653eSE "+bgm)}};
core.prototype.show=function(a,b,c){if(core.isset(b)){a.style.display="block";var d=a.style.opacity=0,e=window.setInterval(function(){d+=.03;a.style.opacity=d;1<d&&(clearInterval(e),core.isset(c)&&c())},b)}else a.style.display="block"};core.prototype.hide=function(a,b,c){if(core.isset(b))var d=1,e=window.setInterval(function(){d-=.03;a.style.opacity=d;0>d&&(a.style.display="none",clearInterval(e),core.isset(c)&&c())},b);else a.style.display="none"};
core.prototype.clearStatusBar=function(){"floor lv hp atk def mdef money experience up yellowKey blueKey redKey poison weak curse hard".split(" ").forEach(function(a){core.statusBar[a].innerHTML="&nbsp;"});core.statusBar.image.book.style.opacity=.3;core.statusBar.image.fly.style.opacity=.3};
core.prototype.updateStatusBar=function(){core.events.checkLvUp();0<core.values.HPMAX&&core.setStatus("hp",Math.min(core.values.HPMAX,core.getStatus("hp")));core.updateCheckBlock();var a=core.getLvName();core.statusBar.lv.innerHTML=a;/^[+-]?\d+$/.test(a)?core.statusBar.lv.style.fontStyle="italic":core.statusBar.lv.style.fontStyle="normal";"hp atk def mdef money experience".split(" ").forEach(function(a){core.statusBar[a].innerHTML=core.getStatus(a)});core.statusBar.up.innerHTML=core.flags.enableLevelUp&&
core.status.hero.lv<core.firstData.levelUp.length?core.firstData.levelUp[core.status.hero.lv].need||"&nbsp;":"&nbsp;";["yellowKey","blueKey","redKey"].forEach(function(a){core.statusBar[a].innerHTML=core.setTwoDigits(core.status.hero.items.keys[a])});core.flags.enableDebuff&&(core.statusBar.poison.innerHTML=core.hasFlag("poison")?"\u6bd2":"",core.statusBar.weak.innerHTML=core.hasFlag("weak")?"\u8870":"",core.statusBar.curse.innerHTML=core.hasFlag("curse")?"\u5492":"");core.statusBar.hard.innerHTML=
core.status.hard;core.status.replay.replaying?(core.statusBar.image.book.src=core.status.replay.pausing?core.statusBar.icons.play.src:core.statusBar.icons.pause.src,core.statusBar.image.book.style.opacity=1,core.statusBar.image.fly.src=core.statusBar.icons.stop.src,core.statusBar.image.fly.style.opacity=1,core.statusBar.image.toolbox.style.opacity=0,core.statusBar.image.shop.style.opacity=0,core.statusBar.image.save.src=core.statusBar.icons.rewind.src,core.statusBar.image.save.style.opacity=1,core.statusBar.image.load.src=
core.statusBar.icons.forward.src,core.statusBar.image.load.style.opacity=1,core.statusBar.image.settings.style.opacity=0):(core.statusBar.image.book.src=core.statusBar.icons.book.src,core.statusBar.image.book.style.opacity=core.hasItem("book")?1:.3,core.statusBar.image.fly.src=core.statusBar.icons.fly.src,core.statusBar.image.fly.style.opacity=core.hasItem("fly")?1:.3,core.statusBar.image.toolbox.src=core.statusBar.icons.toolbox.src,core.statusBar.image.toolbox.style.opacity=1,core.statusBar.image.shop.style.opacity=
1,core.statusBar.image.save.src=core.statusBar.icons.save.src,core.statusBar.image.save.style.opacity=1,core.statusBar.image.load.src=core.statusBar.icons.load.src,core.statusBar.image.load.style.opacity=1,core.statusBar.image.settings.src=core.statusBar.icons.settings.src,core.statusBar.image.settings.style.opacity=1);core.updateFg()};
core.prototype.resize=function(a,b){var c=a,d=!1;a>b&&422>b&&(d=!0,c=b);var e,f;var g=11;core.flags.enableFloor||g--;core.flags.enableLv||g--;core.flags.enableMDef||g--;core.flags.enableMoney||g--;core.flags.enableExperience||g--;core.flags.enableLevelUp||g--;core.flags.enableDebuff||g--;var h=288/g;var k=16;9<g&&(k=9*k/g);var m=f="3px #fff solid";var l=1-(422-c)/4.22/100;if(554>c)if(422>c?core.domStyle.scale=l:(c=422,core.domStyle.scale=1),l=core.domStyle.scale,f=422*l,d){core.domStyle.screenMode=
"horizontal";d="none";var n=f+132*l;var p=f;var r=0;var t=e=132*l;var q=l*h*g+6;f="3px #fff solid";var u=l*h*.8;var v=.8*h*l;var y=c-q;h=l*h*g+6;m="3px #fff solid";var x=32*l;var z=k*l;var A=16*l;g="";k=132*l;var B=132*l;var w=6*l;var C=6*l}else core.domStyle.screenMode="vertical",d="block",n=parseInt((g-1)/3)+1,q=l*(32*n+6)+6,m=44*l+6,p=f+q+m,n=f,r=q,t=e=c,f="3px #fff solid",u=25.6*l,v=25.6*l,k=132*l*.95,y=m,h=q+c,m="3px #fff solid",x=32*l,B=132*l*.4,g="3px #fff solid",w=6*l,C=12*l,z=16*l,A=16*l;
else core.domStyle.scale=1,core.domStyle.screenMode="bigScreen",d="none",n=554,c=p=422,r=0,t=e=132,q=h*g+6,u=.8*h,v=.8*h,y=422-q,h=h*g+6,x=32,g="",z=k,A=16,k=132,B=118.8,C=w=6;core.domStyle.styles=[{id:"gameGroup",rules:{width:n+"px",height:p+"px",top:(b-p)/2+"px",left:(a-n)/2+"px"}},{className:"gameCanvas",rules:{width:c+"px",height:c+"px",top:r+"px",right:0,border:"3px #fff solid"}},{id:"curtain",rules:{width:c-6+"px",height:c-6+"px",top:r+3+"px",right:"3px"}},{id:"floorMsgGroup",rules:{width:c-
6+"px",height:p-6+"px",top:"3px",right:"3px"}},{id:"statusBar",rules:{width:e+"px",height:q+"px",top:0,left:0,padding:"3px",borderTop:f,borderLeft:f,borderRight:g,fontSize:z+"px"}},{className:"status",rules:{width:"100%",maxWidth:k+"px",height:u+"px",margin:w/2+"px"}},{className:"statusLabels",rules:{marginLeft:w+"px",lineHeight:v+"px"}},{id:"toolBar",rules:{width:t+"px",height:y+"px",top:h+"px",left:0,padding:"3px",borderBottom:m,borderLeft:m,borderRight:g,fontSize:A+"px"}},{className:"tools",rules:{height:x+
"px",maxWidth:B+"px",marginLeft:C+"px",marginTop:w+"px"}},{imgId:"shop",rules:{display:d}},{id:"floorCol",rules:{display:core.flags.enableFloor?"block":"none"}},{id:"lvCol",rules:{display:core.flags.enableLv?"block":"none"}},{id:"mdefCol",rules:{display:core.flags.enableMDef?"block":"none"}},{id:"moneyCol",rules:{display:core.flags.enableMoney?"block":"none"}},{id:"expCol",rules:{display:core.flags.enableExperience?"block":"none"}},{id:"upCol",rules:{display:core.flags.enableLevelUp?"block":"none"}},
{id:"debuffCol",rules:{display:core.flags.enableDebuff?"block":"none"}},{id:"hard",rules:{lineHeight:x+"px"}}];core.domRenderer()};
core.prototype.domRenderer=function(){core.dom.statusBar.style.display="block";core.dom.toolBar.style.display="block";for(var a=core.domStyle.styles,b=0;b<a.length;b++)if(a[b].hasOwnProperty("rules")){var c=a[b].rules,d=Object.keys(c);if(a[b].hasOwnProperty("className"))for(var e=a[b].className,f=0;f<core.dom[e].length;f++)for(var g=0;g<d.length;g++)core.dom[e][f].style[d[g]]=c[d[g]];if(a[b].hasOwnProperty("id"))for(e=a[b].id,f=0;f<d.length;f++)core.dom[e].style[d[f]]=c[d[f]];if(a[b].hasOwnProperty("imgId"))for(e=
a[b].imgId,f=0;f<d.length;f++)core.statusBar.image[e].style[d[f]]=c[d[f]]}};core=new core;main.instance.core=core;