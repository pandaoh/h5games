var sampleRate=44100;function AudioPlayer(a,h,e){sampleRate=a.sampleRate;var f=a.createScriptProcessor(16384,0,2);f.onaudioprocess=function(a){a:{if(h.finished)if(e)h.reset(),h.finished=!1;else{f.disconnect();break a}var c=a.outputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(1);for(var k=h.generate(16384),m=0;16384>m;++m)c[m]=k[2*m],a[m]=k[2*m+1]}};return{play:function(){f.connect(a.destination)},pause:function(){f.disconnect()}}}
function MidiFile(a){function h(a){var b=a.read(4),p=a.readInt32();return{id:b,length:p,data:a.read(p)}}function e(a){var b={};b.deltaTime=a.readVarInt();var c=a.readInt8();if(240==(c&240)){if(255==c){b.type="meta";c=a.readInt8();var d=a.readVarInt();switch(c){case 0:b.subtype="sequenceNumber";if(2!=d)throw"Expected length for sequenceNumber event is 2, got "+d;b.number=a.readInt16();return b;case 1:return b.subtype="text",b.text=a.read(d),b;case 2:return b.subtype="copyrightNotice",b.text=a.read(d),
b;case 3:return b.subtype="trackName",b.text=a.read(d),b;case 4:return b.subtype="instrumentName",b.text=a.read(d),b;case 5:return b.subtype="lyrics",b.text=a.read(d),b;case 6:return b.subtype="marker",b.text=a.read(d),b;case 7:return b.subtype="cuePoint",b.text=a.read(d),b;case 32:b.subtype="midiChannelPrefix";if(1!=d)throw"Expected length for midiChannelPrefix event is 1, got "+d;b.channel=a.readInt8();return b;case 47:b.subtype="endOfTrack";if(0!=d)throw"Expected length for endOfTrack event is 0, got "+
d;return b;case 81:b.subtype="setTempo";if(3!=d)throw"Expected length for setTempo event is 3, got "+d;b.microsecondsPerBeat=(a.readInt8()<<16)+(a.readInt8()<<8)+a.readInt8();return b;case 84:b.subtype="smpteOffset";if(5!=d)throw"Expected length for smpteOffset event is 5, got "+d;c=a.readInt8();b.frameRate={0:24,32:25,64:29,96:30}[c&96];b.hour=c&31;b.min=a.readInt8();b.sec=a.readInt8();b.frame=a.readInt8();b.subframe=a.readInt8();return b;case 88:b.subtype="timeSignature";if(4!=d)throw"Expected length for timeSignature event is 4, got "+
d;b.numerator=a.readInt8();b.denominator=Math.pow(2,a.readInt8());b.metronome=a.readInt8();b.thirtyseconds=a.readInt8();return b;case 89:b.subtype="keySignature";if(2!=d)throw"Expected length for keySignature event is 2, got "+d;b.key=a.readInt8(!0);b.scale=a.readInt8();return b;case 127:return b.subtype="sequencerSpecific",b.data=a.read(d),b;default:return b.subtype="unknown",b.data=a.read(d),b}}if(240==c)return b.type="sysEx",d=a.readVarInt(),b.data=a.read(d),b;if(247==c)return b.type="dividedSysEx",
d=a.readVarInt(),b.data=a.read(d),b;throw"Unrecognised MIDI event type byte: "+c;}0==(c&128)?(d=c,c=f):(d=a.readInt8(),f=c);var e=c>>4;b.channel=c&15;b.type="channel";switch(e){case 8:return b.subtype="noteOff",b.noteNumber=d,b.velocity=a.readInt8(),b;case 9:return b.noteNumber=d,b.velocity=a.readInt8(),b.subtype=0==b.velocity?"noteOff":"noteOn",b;case 10:return b.subtype="noteAftertouch",b.noteNumber=d,b.amount=a.readInt8(),b;case 11:return b.subtype="controller",b.controllerType=d,b.value=a.readInt8(),
b;case 12:return b.subtype="programChange",b.programNumber=d,b;case 13:return b.subtype="channelAftertouch",b.amount=d,b;case 14:return b.subtype="pitchBend",b.value=d+(a.readInt8()<<7),b;default:throw"Unrecognised MIDI event type: "+e;}}var f;stream=Stream(a);a=h(stream);if("MThd"!=a.id||6!=a.length)throw"Bad .mid file - header not found";var c=Stream(a.data);a=c.readInt16();var g=c.readInt16();c=c.readInt16();if(c&32768)throw"Expressing time division in SMTPE frames is not supported yet";ticksPerBeat=
c;a={formatType:a,trackCount:g,ticksPerBeat};g=[];for(c=0;c<a.trackCount;c++){g[c]=[];var k=h(stream);if("MTrk"!=k.id)throw"Unexpected chunk - expected MTrk, got "+k.id;for(k=Stream(k.data);!k.eof();){var m=e(k);g[c].push(m)}}return{header:a,tracks:g}}
function Replayer(a,h){function e(){var b={},a=PianoProgram;return{noteOn:function(c,l){b[c]&&!b[c].released&&b[c].noteOff();generator=a.createNote(c,l);h.addGenerator(generator);b[c]=generator},noteOff:function(a,c){b[a]&&!b[a].released&&b[a].noteOff(c)},setProgram:function(b){a=PROGRAMS[b]||PianoProgram}}}function f(){for(var c=null,e=null,f=null,l=0;l<g.length;l++)null!=g[l].ticksToNextEvent&&(null==c||g[l].ticksToNextEvent<c)&&(c=g[l].ticksToNextEvent,e=l,f=g[l].nextEventIndex);if(null!=e){var p=
a.tracks[e][f];g[e].ticksToNextEvent=a.tracks[e][f+1]?g[e].ticksToNextEvent+a.tracks[e][f+1].deltaTime:null;g[e].nextEventIndex+=1;for(l=0;l<g.length;l++)null!=g[l].ticksToNextEvent&&(g[l].ticksToNextEvent-=c);b={ticksToEvent:c,event:p,track:e};q+=c/m/(k/60)*h.sampleRate}else q=b=null,d.finished=!0}function c(){for(var b=0;b<a.tracks.length;b++)g[b]={nextEventIndex:0,ticksToNextEvent:a.tracks[b].length?a.tracks[b][0].deltaTime:null};for(b=0;16>b;b++)p[b]=e();q=0;f()}var g=[],k=120,m=a.header.ticksPerBeat,
p=[],b,q;c();var d={reset:c,generate:function(a){for(var c=Array(2*a),e=0;;)if(null!=q&&q<=a){var d=Math.ceil(q);0<d&&(h.generateIntoBuffer(d,c,e),e+=2*d,a-=d,q-=d);d=b.event;switch(d.type){case "meta":switch(d.subtype){case "setTempo":k=6E7/d.microsecondsPerBeat}break;case "channel":switch(d.subtype){case "noteOn":p[d.channel].noteOn(d.noteNumber,d.velocity);break;case "noteOff":p[d.channel].noteOff(d.noteNumber,d.velocity);break;case "programChange":p[d.channel].setProgram(d.programNumber)}}f()}else{0<
a&&(h.generateIntoBuffer(a,c,e),q-=a);break}return c},finished:!1};return d}
function Stream(a){function h(f){var c=a.charCodeAt(e);f&&127<c&&(c-=256);e+=1;return c}var e=0;return{eof:function(){return e>=a.length},read:function(f){var c=a.substr(e,f);e+=f;return c},readInt32:function(){var f=(a.charCodeAt(e)<<24)+(a.charCodeAt(e+1)<<16)+(a.charCodeAt(e+2)<<8)+a.charCodeAt(e+3);e+=4;return f},readInt16:function(){var f=(a.charCodeAt(e)<<8)+a.charCodeAt(e+1);e+=2;return f},readInt8:h,readVarInt:function(){for(var a=0;;){var c=h();if(c&128)a+=c&127,a<<=7;else return a+c}}}}
function SineGenerator(a){var h={alive:!0},e=sampleRate/a,f=0;h.generate=function(a,h,k){for(;k;k--){var c=Math.sin(f/e*2*Math.PI);a[h++]+=c;a[h++]+=c;f++}};return h}function SquareGenerator(a,h){var e={alive:!0},f=sampleRate/a,c=0;e.generate=function(a,e,m){for(;m;m--){var k=c/f%1>h?1:-1;a[e++]+=k;a[e++]+=k;c++}};return e}
function ADSRGenerator(a,h,e,f,c,g){var k={alive:!0},m=sampleRate*f,p=sampleRate*(f+c),b=(h-e)/(p-m),q=null,d=null,t=e/(sampleRate*g),n=0;k.noteOff=function(){k.released||(q=n,k.released=!0,d=q+sampleRate*g)};k.generate=function(c,f,g){if(k.alive){for(var l=Array(2*g),r=0;r<2*g;r++)l[r]=0;a.generate(l,0,g);for(childOffset=0;g;)if(null!=q)if(n<d)for(;g&&n<d;)r=e-t*(n-q),c[f++]+=l[childOffset++]*r,c[f++]+=l[childOffset++]*r,n++,g--;else{k.alive=!1;break}else if(n<m)for(;g&&n<m;)r=h*n/m,c[f++]+=l[childOffset++]*
r,c[f++]+=l[childOffset++]*r,n++,g--;else if(n<p)for(;g&&n<p;)r=h-b*(n-m),c[f++]+=l[childOffset++]*r,c[f++]+=l[childOffset++]*r,n++,g--;else for(;g;)c[f++]+=l[childOffset++]*e,c[f++]+=l[childOffset++]*e,n++,g--}};return k}function midiToFrequency(a){return 440*Math.pow(2,(a-69)/12)}
PianoProgram={attackAmplitude:.2,sustainAmplitude:.1,attackTime:.02,decayTime:.3,releaseTime:.02,createNote:function(a,h){a=midiToFrequency(a);return ADSRGenerator(SineGenerator(a),h/128*this.attackAmplitude,h/128*this.sustainAmplitude,this.attackTime,this.decayTime,this.releaseTime)}};StringProgram={createNote:function(a,h){a=midiToFrequency(a);return ADSRGenerator(SineGenerator(a),h/128*.5,h/128*.2,.4,.8,.4)}};
PROGRAMS={41:StringProgram,42:StringProgram,43:StringProgram,44:StringProgram,45:StringProgram,46:StringProgram,47:StringProgram,49:StringProgram,50:StringProgram};function Synth(a){function h(a,c,g){for(var f=g;f<g+2*a;f++)c[f]=0;for(f=e.length-1;0<=f;f--)e[f].generate(c,g,a),e[f].alive||e.splice(f,1)}var e=[];return{sampleRate:a,addGenerator:function(a){e.push(a)},generate:function(a){var c=Array(2*a);h(a,c,0);return c},generateIntoBuffer:h}};